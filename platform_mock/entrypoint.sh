#!/bin/sh

DIR=$(dirname $0)

cd $DIR

# run zookeeper
./kafka/bin/zookeeper-server-start.sh -daemon kafka/config/zookeeper.properties

# run kafka
./kafka/bin/kafka-server-start.sh -daemon kafka/config/server.properties

# wait until kafka starts
>&2 echo "Checking if Kafka server is up"
until ./kafka/bin/kafka-topics.sh --list --zookeeper localhost:2181 &> /dev/null; do
  >&2 echo "Kafka server is unavailable - sleeping"
  sleep 1
done

# create topics with multiple partitions for scaling
for topic in platform.inventory.events vulnerability.evaluator.upload \
vulnerability.evaluator.recalc platform.engine.results platform.remediation-updates.vulnerability
do
    ./kafka/bin/kafka-topics.sh --create --topic $topic --partitions 10 --zookeeper localhost:2181 --replication-factor 1
done

# create cyndi mock in database
echo "Inserting Cyndi mock data"
CYNDI_MOCK=$(cat cyndi_data.sql)
export PGPASSWORD=$POSTGRESQL_PASSWORD
psql -c "$CYNDI_MOCK" -d $POSTGRESQL_DATABASE -h $POSTGRESQL_HOST -U $POSTGRESQL_USER

# run upload mock
exec python3 -m platform_mock.platform_mock

