FROM centos:7

RUN yum -y update \
    && yum -y install centos-release-scl \
    && yum -y install rh-python36 postgresql \
    && rm -rf /var/cache/yum/* 

ENV APPBASEDIR=/listener

ADD $APPBASEDIR/*.sh $APPBASEDIR/
ADD $APPBASEDIR/*.py $APPBASEDIR/
ADD $APPBASEDIR/common/*.py $APPBASEDIR/common/
ADD /database/*.py $APPBASEDIR/database/
ADD scl-enable.sh $APPBASEDIR/

RUN adduser --gid 0 -d $APPBASEDIR --no-create-home -c 'Red Hat Insights' insights
RUN chown -R insights $APPBASEDIR

RUN $APPBASEDIR/scl-enable.sh pip install --upgrade pip
# Install Python libs as user
USER insights
RUN $APPBASEDIR/scl-enable.sh pip install --user psycopg2-binary tornado requests insights-core aiokafka

EXPOSE 8000

CMD ["sh", "-c", "$APPBASEDIR/scl-enable.sh $APPBASEDIR/entrypoint.sh"]
