FROM centos:7

RUN yum -y update \
        && yum -y install centos-release-scl \
        && yum -y install rh-python36 java-openjdk-headless \
        && rm -rf /var/cache/yum/*

ENV APPBASEDIR=/platform_mock

ADD $APPBASEDIR/*.sh $APPBASEDIR/
ADD $APPBASEDIR/*.py $APPBASEDIR$APPBASEDIR/
ADD /common/*.py $APPBASEDIR/common/
ADD scl-enable.sh $APPBASEDIR/
ADD wait-for-services.sh $APPBASEDIR/

RUN touch $APPBASEDIR/__init__.py

RUN cd $APPBASEDIR \
        && mkdir kafka \
        && curl https://www.apache.org/dist/kafka/2.2.0/kafka_2.12-2.2.0.tgz \
        | tar -xz --strip-components=1 -C kafka/

RUN adduser --gid 0 -d $APPBASEDIR --no-create-home -c 'Red Hat Insights' insights

RUN chown -R insights $APPBASEDIR

RUN $APPBASEDIR/scl-enable.sh pip install --upgrade pip

RUN $APPBASEDIR/scl-enable.sh pip install tornado "aiokafka==0.5.0" insights-core

USER insights

EXPOSE 9092 8000

CMD ["sh", "-c", "$APPBASEDIR/scl-enable.sh $APPBASEDIR/entrypoint.sh"]
