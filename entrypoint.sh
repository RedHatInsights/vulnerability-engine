#!/bin/sh

cd $(dirname $0)

if [[ ! -z $1 ]]; then
    if [[ "$1" == "listener" ]]; then
        exec python3 -m listener.upload_listener
    elif [[ "$1" == "evaluator" ]]; then
        exec python3 -m evaluator.evaluator
    elif [[ "$1" == "vmaas-sync" ]]; then
        exec python3 -m vmaas_sync.vmaas_sync
    elif [[ "$1" == "manager" ]]; then
        port=$(python3 -c "import app_common_python as a;print(a.LoadedConfig.publicPort or 8000)")
        exec gunicorn -c manager/gunicorn_conf.py -w ${GUNICORN_WORKERS:-4} --bind=0.0.0.0:${port} --timeout=60 manager.main
    elif [[ "$1" == "manager-dev" ]]; then
        exec gunicorn --reload -c manager/gunicorn_conf.py -w ${GUNICORN_WORKERS:-4} --bind=0.0.0.0:8000 --timeout=60 manager.main
    elif [[ "$1" == "manager-admin" ]]; then
        port=$(python3 -c "import app_common_python as a;print(a.LoadedConfig.privatePort or 8000)")
        exec gunicorn -c manager/gunicorn_conf.py -w ${GUNICORN_WORKERS:-4} --bind=0.0.0.0:${port} --timeout=60 manager.admin
    elif [[ "$1" == "advisor-listener" ]]; then
        exec python3 -m advisor_listener.advisor_listener
    elif [[ "$1" == "taskomatic" ]]; then
        exec python3 -m taskomatic.taskomatic
    elif [[ "$1" == "metrics" ]]; then
        exec python3 -m metrics.metrics_gather
    fi
fi

echo "Please specify service name as the first argument."
