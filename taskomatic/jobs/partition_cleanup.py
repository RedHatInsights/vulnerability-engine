"""
System vulnerable package cleanup
"""
from common.config import Config
from common.logging import get_logger
from common.logging import init_logging
from taskomatic.jobs.common import get_conn

LOGGER = get_logger(__name__)

CFG = Config()


def run():
    """Job entrypoint"""
    LOGGER.info("Started partition_cleanup job.")

    conn = get_conn()
    cur = conn.cursor()

    for part in range(256):
        cur.execute(
            f"""select distinct system_id from system_vulnerable_package_{part}
                where first_reported >= '2024-07-17 11:00' and first_reported <= '2024-07-17 15:55'
            """
        )
        systems = [sys[0] for sys in cur]
        system_count = len(systems)
        for idx, sys in enumerate(systems):
            cur.execute(
                f"""delete from system_vulnerable_package_{part}
                    where system_id = %s and first_reported >= '2024-07-17 11:00' and first_reported <= '2024-07-17 15:55'
                """, (sys,)
            )
            conn.commit()
            LOGGER.info("Cleaning up partition %s, system %s/%s", part, idx+1, system_count)

    cur.close()
    conn.close()

    LOGGER.info("Finished partition_cleanup job.")


if __name__ == "__main__":
    init_logging()
    run()
