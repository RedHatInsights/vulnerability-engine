"""
Periodic discovery of stale systems
"""

import os

import psycopg2

DB_NAME = os.getenv('POSTGRESQL_DATABASE')
DB_USER = os.getenv('POSTGRESQL_USER')
DB_PASS = os.getenv('POSTGRESQL_PASSWORD')
DB_HOST = os.getenv('POSTGRESQL_HOST')
DB_PORT = int(os.getenv('POSTGRESQL_PORT', '5432'))


def run():
    """Application entrypoint"""
    conn = psycopg2.connect(dbname=DB_NAME, user=DB_USER, password=DB_PASS, host=DB_HOST, port=DB_PORT)
    cur = conn.cursor()
    cur.execute("""UPDATE system_platform set stale = 'T'
                    where stale_timestamp IS NOT NULL
                    AND stale = 'F'
                    AND now() > stale_timestamp""")
    conn.commit()
    cur.close()
    conn.close()
