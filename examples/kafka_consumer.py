import os
import logging
import datetime
from confluent_kafka import Consumer, KafkaError

BOOTSTRAP_SERVERS = 'kafka-1.vmaas-ci.svc:29092'
GROUP_ID = 'vulnerability' # The group ID for this service broker
ENGINE_RESULTS_TOPIC = 'vulnerability_results'  # the topic to subscribe to for engine results

logging.basicConfig(level=logging.INFO)
logging.info("Using BOOTSTRAP_SERVERS: %s" % BOOTSTRAP_SERVERS)
logging.info("Using GROUP_ID: %s" % GROUP_ID)
logging.info("Using ENGINE_RESULTS_TOPIC: %s" % ENGINE_RESULTS_TOPIC)

c = Consumer({
        'bootstrap.servers': BOOTSTRAP_SERVERS,
        'group.id': GROUP_ID,
        'default.topic.config': {
            'auto.offset.reset': 'smallest'
        }
    })

topic_subscriptions = [ENGINE_RESULTS_TOPIC]
c.subscribe(topic_subscriptions)

while True:
    msg = c.poll(1.0)

    if msg is None:
        continue
    if msg.error():
        if msg.error().code() == KafkaError._PARTITION_EOF:
            continue
        else:
            logging.info(msg.error())

    logging.info('Received Platform Kafka message at {} from topic {}: {}'.format(datetime.datetime.now(), msg.topic(), msg.value()))

c.close()

