"""
Common feature flags with Unleash to be used for multiple apps
"""
import os
from pathlib import Path

from UnleashClient import UnleashClient
from UnleashClient.cache import FileCache

from .config import Config

CFG = Config()
APP_NAME = "vulnerability-engine"


def _setup_unleash():
    """
    Initializes Unleash client.

    Feature flags can be bootstraped using `UNLEASH_BOOTSTRAP_FILE` environment
    pointing to a JSON file.  The file must follow Unleash's API /api/client/features
    https://docs.getunleash.io/api/client/features.
    """
    cache = None
    if os.environ.get("UNLEASH_BOOTSTRAP_FILE"):
        cache = FileCache(APP_NAME, directory=CFG.unleash_cache_dir)
        cache.bootstrap_from_file(Path(os.environ.get("UNLEASH_BOOTSTRAP_FILE")))

    client = UnleashClient(
        url=CFG.unleash_url or "",
        app_name=APP_NAME,
        cache=cache,
        cache_directory=CFG.unleash_cache_dir,
        custom_headers={"Authorization": f"Bearer {CFG.unleash_token}"},
    )

    if CFG.unleash_url:
        client.initialize_client()
    return client


UNLEASH = _setup_unleash()
