#!/usr/bin/bash

TESTDIR=$1
if [ ! -d "$TESTDIR" ] ; then
    echo "usage: $(basename $0) <testdir>" >&2
    exit 1
fi

dockerfile=""
pylint=true

if [ "$TESTDIR" == "database" ] ; then
    dockerfile="Dockerfile-database"
    pylint=false
fi

# for listener copy common code
if [ "$TESTDIR" == "listener" ] ; then
    cp -r common/ listener/
    dockerfile="Dockerfile-listener"
fi

# for evaluator copy common code
if [ "$TESTDIR" == "evaluator" ] ; then
    cp -r common/ evaluator/
    dockerfile="Dockerfile-evaluator"
fi

# for manager copy also common code
if [ "$TESTDIR" == "manager" ] ; then
    cp -r common/ manager/
    dockerfile="Dockerfile-manager"
fi

if [ ! -f "$dockerfile" ]; then
    echo "Dockerfile '$dockerfile' doesn't exist" >&2
    exit 2
fi

rc=0
cat $dockerfile | sed "s/centos:7/registry.access.redhat.com\/rhel7/" \
	        | sed "s/centos\/postgresql-96-centos7/registry.access.redhat.com\/rhscl\/postgresql-96-rhel7/" \
	        | sed "s/yum -y install centos-release-scl/yum-config-manager --enable rhel-server-rhscl-7-rpms/" \
		| diff $dockerfile.rhel7 -
rc=$(($rc+$?))

if [ $rc -gt 0 ]; then
    echo "$dockerfile and $dockerfile.rhel7 are too different!"
fi

if [ "$pylint" = false ]; then
    exit $rc
fi

(
# Go to script's directory
cd "$TESTDIR"

# Run pylint
find . -iname '*.py' | xargs pylint --rcfile=../pylintrc
rc=$(($rc+$?))

exit $rc
)

