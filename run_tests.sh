#!/usr/bin/bash

rc=0

for dockerfile in Dockerfile-database Dockerfile-listener Dockerfile-evaluator Dockerfile-manager
do
    if [ ! -f "$dockerfile" ]; then
        echo "Dockerfile '$dockerfile' doesn't exist" >&2
        rc=$(($rc+1))
    fi
    sed \
        -e "s/centos:7/registry.access.redhat.com\/rhel7/" \
        -e "s/centos\/postgresql-96-centos7/registry.access.redhat.com\/rhscl\/postgresql-96-rhel7/" \
        -e "s/yum -y install centos-release-scl/yum-config-manager --enable rhel-server-rhscl-7-rpms/" \
        "$dockerfile" | diff "${dockerfile}.rhel7" -
    diff_rc=$?
    if [ $diff_rc -gt 0 ]; then
        echo "$dockerfile and $dockerfile.rhel7 are too different!"
    fi
    rc=$(($rc+$diff_rc))
done

# Run pylint
for testdir in common listener evaluator manager
do
    find $testdir -iname '*.py' | xargs pylint --rcfile=./pylintrc
    rc=$(($rc+$?))
done

# Run unit tests
pytest -vvv --cov-report term --cov
rc=$(($rc+$?))

exit $rc
