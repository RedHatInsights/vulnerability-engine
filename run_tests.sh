#!/usr/bin/bash

TESTDIR=$1
if [ ! -d "$TESTDIR" ] ; then
    echo "usage: $(basename $0) <testdir>" >&2
    exit 1
fi

unittests=true
if [ "$2" = "-n" ]; then
  unittests=false
fi

dockerfile=""
pylint=true

if [ "$TESTDIR" == "database" ] ; then
    dockerfile="Dockerfile-database"
    pylint=false
fi

if [ "$TESTDIR" == "listener" ] ; then
    dockerfile="Dockerfile-listener"
fi

if [ "$TESTDIR" == "evaluator" ] ; then
    dockerfile="Dockerfile-evaluator"
fi

if [ "$TESTDIR" == "manager" ] ; then
    dockerfile="Dockerfile-manager"
fi

if [ ! -f "$dockerfile" ]; then
    echo "Dockerfile '$dockerfile' doesn't exist" >&2
    exit 2
fi

rc=0
sed \
    -e "s/centos:7/registry.access.redhat.com\/rhel7/" \
    -e "s/centos\/postgresql-96-centos7/registry.access.redhat.com\/rhscl\/postgresql-96-rhel7/" \
    -e "s/yum -y install centos-release-scl/yum-config-manager --enable rhel-server-rhscl-7-rpms/" \
    "$dockerfile" | diff "${dockerfile}.rhel7" -
rc=$(($rc+$?))

if [ $rc -gt 0 ]; then
    echo "$dockerfile and $dockerfile.rhel7 are too different!"
fi

# Run unit tests
[ "$unittests" = true ] && pytest -vvv --cov-report term --cov

if [ "$pylint" = false ]; then
    exit $rc
fi

(
# Go to script's directory
cd "$TESTDIR"

# Run pylint
find . -iname '*.py' | xargs pylint --rcfile=../pylintrc
rc=$(($rc+$?))

exit $rc
)
