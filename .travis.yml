branches:
  only:
    - master
sudo: required
services:
  - docker
language: python
python:
  - "3.6"
notifications:
  email: false
install:
  - pip install pylint tornado psycopg2 requests "apispec==0.39.0" peewee python-dateutil kafka pytest insights-core prometheus_client aiokafka
script:
  - /bin/bash run_tests.sh database
  - /bin/bash run_tests.sh evaluator
  - /bin/bash run_tests.sh manager
  - /bin/bash run_tests.sh listener
  - docker-compose up -d ve_database ve_manager || exit 127
  - docker ps
  - source conf/database-connection-admin.env
  - export POSTGRESQL_HOST=localhost
  - export POSTGRESQL_PORT=15432
  - export POSTGRESQL_PASSWORD
  - export POSTGRESQL_USER
  - export POSTGRESQL_DATABASE
  - bash wait-for-services.sh
  - PGPASSWORD=$POSTGRESQL_PASSWORD psql -U $POSTGRESQL_USER -h $POSTGRESQL_HOST -p $POSTGRESQL_PORT -d $POSTGRESQL_DATABASE < database/ve_db_dev_data.sql
  - pytest manager/test/test.py
