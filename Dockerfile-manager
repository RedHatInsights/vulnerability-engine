FROM fedora:28

RUN dnf -y update && dnf install -y dnf-plugins-core && dnf copr enable -y @vmaas/libs \
        && dnf -y install python3-tornado python3-psycopg2 \
                          python3-requests postgresql python3-apispec \
                          python3-dateutil python3-pip \
        && pip3 install prometheus_client peewee \
        && rm -rf /var/cache/dnf/*

ENV APPBASEDIR=/manager
ENV INSIGHTS_VULNERABILITY_VERSION=latest

ADD $APPBASEDIR/entrypoint.sh $APPBASEDIR/
ADD $APPBASEDIR/*.py $APPBASEDIR/
ADD /common/*.py $APPBASEDIR/common/
ADD wait-for-postgres.sh $APPBASEDIR

RUN adduser --gid 0 -d $APPBASEDIR --no-create-home -c 'Red Hat Insights' insights
USER insights

EXPOSE 8443

CMD ["sh", "-c", "$APPBASEDIR/entrypoint.sh"]
