# Vulnerability Engine Evaluator Service

## Overview
Evaluator service own topic with message events from Listener service. Performs a vulnerability analysis on system by requesting VMaaS with provided system packages and stores the system vulnerabilities (system-cve links) to the database.

## Design
Evaluator is run in two instances, the `upload` or `recalc` instance.
Upload instance is listening for events created by Listener on `vulnerability.evaluator.upload`, thus performs the vulnerability analysis on updated systems straight from the inventory side.
Recalc instance is listening for events from vmaas-sync service on `vlnerability.evaluator.recalc`, thus performs the recalculation of systems already inside of the vulnerability (ex. new CVE is detected, systems needs to be recalculated).
The vulnerability analysis is based on the packages instaled on given system, for each system a VMaaS request is sent and processed.
System CVEs returned from VMaaS are processed by a given logic:
* CVE is present for system in Vulnerability but not in VMaaS response - CVE is mitigated, mark it to db.
* CVE is present for system in Vulnerability and also in VMaaS response - CVE is still present, do not change.
* CVE is not present in Vulnerablity but present in VMaaS response - Insert CVE-system link into database.

System-CVE links are represented in `system_vulnerabilities` table. Evaluator is caching the number of current CVEs to which system is vulnerable to the database, which is later used in some endpoints.
After given evaluation, the new changes are sent to the Notificator service, `vulnerability.evaluator.results`.

### Incoming message
```
{
    "type": <upload_new_file,re-evaluate_system>,
    "host": {
        "id": <inventory id of system>,
        "account": <account id of customer>,
        "org_id": <org id of customer>
    },
    "platform_metadata": {
        "request_id": <id of this request>
    },
    "timestamp": <timestamp when message was recieved>
}
```