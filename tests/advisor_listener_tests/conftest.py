# -*- coding: utf-8 -*-
# pylint:disable=missing-docstring
import asyncpg
import psycopg2
import pytest

from common import database_handler
from ..utils import restore_db


@pytest.fixture(scope="module")
def pg_db_conn(pg_db_mod):
    """Returns connection to PostgreSQL database."""
    conn = psycopg2.connect(**pg_db_mod.dsn())
    yield conn
    conn.close()


@pytest.fixture
def cleanup(request):
    def db_cleanup():
        restore_db(database_handler.pg_testing)

    request.addfinalizer(db_cleanup)


@pytest.fixture(scope="function")
async def asyncio_conn(event_loop) -> asyncpg.Connection:
    """Returns asyncpg connection"""
    aconn = await asyncpg.connect(
        host=database_handler.DB_HOST,
        port=database_handler.DB_PORT,
        user=database_handler.DB_USER,
        password=database_handler.DB_PASS,
        database=database_handler.DB_NAME,
        loop=event_loop,
    )
    yield aconn
    await aconn.close()
