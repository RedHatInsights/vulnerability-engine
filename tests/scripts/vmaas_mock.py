#!/usr/bin/env python3
"""
Mock of VMaaS webapp
"""
import json
import sys
import math

from tornado import gen, httpserver, ioloop, web

CVES_EMPTY = {"cve_list": {}, "page": 1, "page_size": 0, "pages": 0}
CVES_RESPONSE = {
    "cve_list": {
        "CVE-2016-0634": {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2016-0634",
            "impact": "Moderate",
            "public_date": "2015-10-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "4.900",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:L",
            "cvss2_score": "3.700",
            "cvss2_metrics": "AV:L/AC:H/Au:N/C:P/I:P/A:P",
            "description": "An arbitrary command injection flaw was f....",
            "package_list": ["bash-4.2.46-28.el7.x86_64"],
            "errata_list": ["RHSA-2017:1931"],
        },
        "CVE-2018-5": {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-5",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": ["CWE-77"],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "6.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:C/I:C/A:C",
            "description": "An arbitrary command injection flaw ...",
            "package_list": ["bash-4.2.46-28.el7.x86_64"],
            "errata_list": ["RHSA-2017:1931"],
        },
        "CVE-2016-9401": {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2016-9401",
            "impact": "Low",
            "public_date": "2016-11-17T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": ["CWE-416"],
            "cvss3_score": "3.300",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:L",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "A denial of service flaw w...",
            "package_list": ["bash-4.2.46-28.el7.x86_64"],
            "errata_list": ["RHSA-2017:1931"],
        },
        'CVE-2013-1': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2013-1",
            "impact": "Critical",
            "public_date": "2013-11-12T00:00:00+00:00",
            "modified_date": "2013-11-12T00:00:00+00:00",
            "cwe_list": [],
            "cvss3_score": None,
            "cvss3_metrics": None,
            "cvss2_score": None,
            "cvss2_metrics": None,
            "description": "CVE-2013-1 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2014-1': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2014-1",
            "impact": "Important",
            "public_date": "2014-04-07T00:00:00+00:00",
            "modified_date": "2014-04-07T00:00:00+00:00",
            "cwe_list": [],
            "cvss3_score": None,
            "cvss3_metrics": None,
            "cvss2_score": None,
            "cvss2_metrics": None,
            "description": "CVE-2014-1 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2016-1': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2016-1",
            "impact": "Important",
            "public_date": "2016-03-01T00:00:00+00:00",
            "modified_date": "2016-03-01T00:00:00+00:00",
            "cwe_list": [],
            "cvss3_score": "5.900",
            "cvss3_metrics": "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:N/A:N",
            "cvss2_score": None,
            "cvss2_metrics": None,
            "description": "CVE-2016-1 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-1': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-1",
            "impact": "Moderate",
            "public_date": "2018-01-24T00:00:00+00:00",
            "modified_date": "2018-01-24T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-1 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-2': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-2",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-2 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-3': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-3",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-3 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-4': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-4",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-4 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-5': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-5",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-5 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-6': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-6",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-6 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-7': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-7",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-7 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2017-8': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2017-8",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2017-8 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2018-1': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-1",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2018-1 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2018-2': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-2",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2018-2 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2018-3': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-3",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2018-3 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2018-4': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-4",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2018-4 desc",
            "package_list": [],
            "errata_list": [],
        },
        'CVE-2018-6': {
            "redhat_url": "",
            "secondary_url": "",
            "synopsis": "CVE-2018-6",
            "impact": "Moderate",
            "public_date": "2016-09-16T00:00:00+00:00",
            "modified_date": "2019-03-12T12:45:42+00:00",
            "cwe_list": [],
            "cvss3_score": "7.000",
            "cvss3_metrics": "CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H",
            "cvss2_score": "1.900",
            "cvss2_metrics": "AV:L/AC:M/Au:N/C:N/I:N/A:P",
            "description": "CVE-2018-6 desc",
            "package_list": [],
            "errata_list": [],
        }
    },
    "page": 1,
    "page_size": 19,
    "pages": 1,
}

VULNERABILITIES_EMPTY = {
    "cve_list": [],
    "manually_fixable_cve_list": []
}
VULNERABILITIES_RESPONSE = {
    "cve_list": ["CVE-2018-5", "CVE-2016-0634", "CVE-2016-9401"],
    "manually_fixable_cve_list": []
}
REPOS_EMPTY = {
    "repository_list": {}, "page": 1, "page_size": 0, "pages": 0
}
REPOS_RESPONSE = {
    "repository_list": {
        "rhel-6-server-rpms": [{
            "label": "rhel-6-server-rpms",
            "name": "Red Hat Enterprise Linux 6 Server (RPMs)",
            "url": "https://url",
            "basearch": "x86_64",
            "releasever": "6Server",
            "product": "Red Hat Enterprise Linux Server",
            "revision": "2019-07-17T12:53:14.950647+00:00"
        }],
        "rhel-7-server-rpms": [{
            "label": "rhel-7-server-rpms",
            "name": "Red Hat Enterprise Linux 7 Server (RPMs)",
            "url": "https://url",
            "basearch": "x86_64",
            "releasever": "7Server",
            "product": "Red Hat Enterprise Linux Server",
            "revision": "2019-07-17T12:53:14.950647+00:00"
        }],
        "vmaas-test-rhel8-module": [{
            "label": "vmaas-test-rhel8-module",
            "name": "VMaaS testing RHEL8 modularity repo",
            "url": "https://url",
            "basearch": "x86_64",
            "releasever": "8",
            "product": "VMaaS testing - modularity",
            "revision": "2019-07-17T12:53:14.950647+00:00"
        }]
    },
    "page": 1,
    "page_size": 3,
    "pages": 1,
    "modified_since": "2018-04-05T01:23:45+02:00"
}

RESPONSES = {"cves": CVES_RESPONSE,
             "vulnerabilities": VULNERABILITIES_RESPONSE,
             "repos": REPOS_RESPONSE}
EMPTY_RESPONSES = {"cves": CVES_EMPTY,
                   "vulnerabilities": VULNERABILITIES_EMPTY,
                   "repos": REPOS_EMPTY}


def dummy_paginate(input_data, page, page_size):
    """Creates pages according response."""
    result = list(input_data.items())[2]
    key = result[0]
    value = result[1]
    result_json = {}
    result_json[key] = value
    pages = int(math.ceil(float(len(input_data)) / page_size))
    return result_json, {"page": page, "page_size": len(result_json), "pages": pages}


class BaseHandler(web.RequestHandler):
    """Base handler."""

    def data_received(self, chunk):
        pass

    def get_data(self):
        """Get json data from POST request."""
        data = self.request.body
        try:
            data = json.loads(data)
        except ValueError:
            data = None
        return data

    @gen.coroutine
    def handle(self, handler_type, data_list):
        """Handle /cves, /vulnerabilities, /repos api endpoints."""
        code = 400
        data = self.get_data()
        if data:
            response = EMPTY_RESPONSES.get(handler_type, {})
            if not data[data_list]:
                code = 200
            elif "FORCE_CODE_400" not in data[data_list][0]:
                response = RESPONSES.get(handler_type, None)
                try:
                    if handler_type != "vulnerabilities" and data['page']:
                        repo_page_to_process, pagination_response = dummy_paginate(
                            response[data_list], data['page'], data['page_size'])
                        response = {}
                        response[data_list] = {}
                        response[data_list].update(repo_page_to_process)
                        response.update(pagination_response)
                except KeyError:
                    code = 400
                code = 200
        else:
            response = "Error: malformed input JSON."

        self.set_status(code)
        self.write(response)


class VulnerabilitiesHandler(BaseHandler):
    """VulnerabilitiesHandler. Handle Vulnerabilities endpoint."""

    def post(self):  # pylint: disable=arguments-differ
        """Handle /vulnerabilities POST request."""
        self.handle("vulnerabilities", "package_list")


class CvesHandler(BaseHandler):
    """CvesHandler. Handle Cves endpoint."""

    def post(self):  # pylint: disable=arguments-differ
        """Handle /cves POST request."""
        self.handle("cves", "cve_list")


class ReposHandler(BaseHandler):
    """ReposHandler. Handle Repos endpoint."""

    def post(self):  # pylint: disable=arguments-differ
        """Handle /repos POST request."""
        self.handle("repos", "repository_list")


APP = web.Application(
    [(r"/api/v1/cves/?", CvesHandler),
     (r"/api/v1/vulnerabilities/?", VulnerabilitiesHandler),
     (r"/api/v1/repos/?", ReposHandler)]
)


def main():
    """Run web server."""
    try:
        port = int(sys.argv[1])
    # pylint: disable=broad-except
    except Exception:
        port = 8080
    server = httpserver.HTTPServer(APP)
    server.listen(port)
    ioloop.IOLoop.current().start()


if __name__ == "__main__":
    main()
