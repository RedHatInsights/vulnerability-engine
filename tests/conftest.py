# -*- coding: utf-8 -*-
# pylint:disable=missing-docstring,redefined-outer-name
import os
import subprocess
import time
import asyncpg
from psycopg_pool import AsyncConnectionPool

import pytest

from common.config import Config
from .utils import check_open_port, get_free_port, get_pg_class, restore_db, set_env, TESTS_DIR, VE_CYNDI_DATA

VMAAS_MOCK = TESTS_DIR.joinpath("scripts", "vmaas_mock.py")
VMAAS_HOST = "localhost"
VMAAS_PORT = get_free_port()

os.environ["VMAAS_HOST"] = f"http://{VMAAS_HOST}:{VMAAS_PORT}"


@pytest.fixture(scope='session')
def monkeypatch_session():
    """Monkeypatch for session scoped fixtures."""
    from _pytest.monkeypatch import MonkeyPatch  # pylint: disable=import-outside-toplevel
    mpatch = MonkeyPatch()
    yield mpatch
    mpatch.undo()


@pytest.fixture(scope="session")
def pg_class():
    """Setup PostgreSQL class."""
    postgres_class = get_pg_class(VE_CYNDI_DATA)
    yield postgres_class
    postgres_class.clear_cache()


@pytest.fixture(scope="session")
def pg_db_session(pg_class):
    """Setup PostgreSQL in session scope."""
    postgresql = pg_class()
    set_env(postgresql)
    yield postgresql
    postgresql.stop()


@pytest.fixture(scope="module")
def pg_db_mod(pg_db_session):
    """Restores PostgreSQL in module scope."""
    yield pg_db_session
    restore_db(pg_db_session)


@pytest.fixture(scope="function")
def pg_db_func(pg_db_session):
    """Restores PostgreSQL in function scope."""
    yield pg_db_session
    restore_db(pg_db_session)


@pytest.fixture(scope="class")
def pg_db_cls(pg_db_session):
    yield pg_db_session
    restore_db(pg_db_session)


# pylint: disable=consider-using-with
@pytest.fixture(scope="session", autouse=True)
def run_vmaas_mock(monkeypatch_session):
    """Runs mocked VMaaS."""
    cfg = Config()
    monkeypatch_session.setattr(cfg, "vmaas_host", os.getenv("VMAAS_HOST"))
    monkeypatch_session.setattr(cfg, "vmaas_vulnerabilities_endpoint", f"{cfg.vmaas_host}{cfg.vmaas_vulnerabilities_api}")
    vmaas_mock = subprocess.Popen([str(VMAAS_MOCK), str(VMAAS_PORT)])
    for __ in range(10):
        if check_open_port(VMAAS_HOST, VMAAS_PORT):
            break
        time.sleep(0.1)

    yield vmaas_mock

    # teardown - stop vmaas_mock
    vmaas_mock.terminate()


@pytest.fixture(scope="session")
async def apg_pool_session(pg_db_session):
    dsn = pg_db_session.dsn()
    dsn_str = f'postgres://{dsn["user"]}@{dsn["host"]}:{dsn["port"]}/{dsn["database"]}'
    aconn = await asyncpg.create_pool(dsn=dsn_str,
                                      min_size=1,
                                      max_size=1)
    yield aconn
    await aconn.close()


@pytest.fixture(scope="class")
async def apg_pool_cls(pg_db_cls):
    dsn = pg_db_cls.dsn()
    dsn_str = f'postgres://{dsn["user"]}@{dsn["host"]}:{dsn["port"]}/{dsn["database"]}'
    aconn = await asyncpg.create_pool(dsn=dsn_str,
                                      min_size=1,
                                      max_size=1)
    yield aconn
    await aconn.close()


@pytest.fixture(scope="class")
async def pg_pool_cls(pg_db_cls):
    dsn = pg_db_cls.dsn()
    dsn_str = f'postgres://{dsn["user"]}@{dsn["host"]}:{dsn["port"]}/{dsn["database"]}'
    pool = AsyncConnectionPool(dsn_str, min_size=1, max_size=1)

    yield pool
    await pool.close()
