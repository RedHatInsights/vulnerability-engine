# -*- coding: utf-8 -*-
# pylint:disable=missing-docstring,no-self-use
"""
Unit tests for metrics module
"""

from datetime import date

import pytest

from metrics.s3_bucket_manager import S3BucketManager
from metrics.metrics_gather import MetricsGatherer

DATA_PREVIOUS = {'cve_status_usage': [('d', 10),
                                      ('f', 9),
                                      ('a', 7),
                                      ('b', 2),
                                      ('e', 1),
                                      ('c', 1)],
                 'system_cve_status_usage': [('a', 10),
                                             ('f', 10),
                                             ('c', 8),
                                             ('b', 7),
                                             ('e', 5)],
                 'cve_business_risk_usage': [('d', 20)]}

DATA_CURRENT = {'cve_status_usage': [('b', 13),
                                     ('f', 11),
                                     ('d', 10),
                                     ('a', 8),
                                     ('c', 5),
                                     ('e', 2),
                                     ('g', 1)],
                'system_cve_status_usage': [('f', 12),
                                            ('b', 12),
                                            ('c', 10),
                                            ('a', 10),
                                            ('e', 3)],
                'cve_business_risk_usage': [('d', 20)]}

DATA_RESULTS = {'cve_business_risk_usage': {'delta': [('d', 0)],
                                            'filtered_delta': [('d', 0)],
                                            'filtered_total': [('d', 20)],
                                            'total': [('d', 20)]},
                'cve_status_usage': {'delta': [('b', 11),
                                               ('c', 4),
                                               ('f', 2),
                                               ('a', 1),
                                               ('e', 1),
                                               ('g', 1),
                                               ('d', 0)],
                                     'filtered_delta': [('b', 11),
                                                        ('c', 4),
                                                        ('f', 2),
                                                        ('g', 1),
                                                        ('d', 0)],
                                     'filtered_total': [('b', 13),
                                                        ('f', 11),
                                                        ('d', 10),
                                                        ('c', 5),
                                                        ('g', 1)],
                                     'total': [('b', 13),
                                               ('f', 11),
                                               ('d', 10),
                                               ('a', 8),
                                               ('c', 5),
                                               ('e', 2),
                                               ('g', 1)]},
                'system_cve_status_usage': {'delta': [('b', 5),
                                                      ('f', 2),
                                                      ('c', 2),
                                                      ('a', 0),
                                                      ('e', -2)],
                                            'filtered_delta': [('b', 5),
                                                               ('f', 2),
                                                               ('c', 2)],
                                            'filtered_total': [('f', 12),
                                                               ('b', 12),
                                                               ('c', 10)],
                                            'total': [('f', 12),
                                                      ('b', 12),
                                                      ('c', 10),
                                                      ('a', 10),
                                                      ('e', 3)]}}


class TestMetricsGather:

    @pytest.fixture(scope='module')
    def metrics_gather(self):
        exclude_accounts = set()
        exclude_accounts.add('a')
        exclude_accounts.add('e')
        mgather = MetricsGatherer(exclude_accounts, S3BucketManager())
        return mgather

    @pytest.mark.parametrize('test_input,expected',
                             [(date(2010, 1, 1), 'metrics-2010-01-01'),
                              (date(2020, 12, 31), 'metrics-2020-12-31')])
    def test_date_to_key(self, metrics_gather, test_input, expected):
        assert metrics_gather.date_to_key(test_input) == expected

    @pytest.mark.parametrize('test_input,expected',
                             [('metrics-2010-01-01', date(2010, 1, 1)),
                              ('metrics-2020-12-31', date(2020, 12, 31))])
    def test_key_to_date(self, metrics_gather, test_input, expected):
        assert metrics_gather.key_to_date(test_input) == expected

    def test_metrics_tuple_list_to_map(self, metrics_gather):
        tuple_list = [('a', 1),
                      ('b', 5),
                      ('f', 13),
                      ('d', 14),
                      ('c', 17),
                      ('e', 22)]
        to_map = metrics_gather.metrics_tuple_list_to_map(tuple_list)
        assert 'a' in to_map
        assert to_map['a'] == 1
        assert 'b' in to_map
        assert to_map['b'] == 5
        assert 'c' in to_map
        assert to_map['c'] == 17
        assert 'd' in to_map
        assert to_map['d'] == 14
        assert 'e' in to_map
        assert to_map['e'] == 22
        assert 'f' in to_map
        assert to_map['f'] == 13

    def test_compare_tuple_lists(self, metrics_gather):
        prev_tuples = [('d', 10),
                       ('f', 9),
                       ('a', 7),
                       ('b', 2),
                       ('e', 1),
                       ('c', 1)]
        cur_tuples = [('b', 13),
                      ('f', 11),
                      ('d', 10),
                      ('a', 8),
                      ('c', 5),
                      ('e', 2),
                      ('g', 1)]
        result_list = metrics_gather.compare_tuple_lists(prev_tuples, cur_tuples)
        assert result_list == [('b', 11),
                               ('c', 4),
                               ('f', 2),
                               ('a', 1),
                               ('e', 1),
                               ('g', 1),
                               ('d', 0)]

    def test_prep_filtered_results(self, metrics_gather):
        tuple_list = [('b', 11),
                      ('c', 4),
                      ('f', 2),
                      ('a', 1),
                      ('e', 1),
                      ('g', 1),
                      ('d', 0)]
        unfiltered_list, filtered_list = metrics_gather.prep_filtered_results(tuple_list)
        assert unfiltered_list == tuple_list
        assert filtered_list == [('b', 11),
                                 ('c', 4),
                                 ('f', 2),
                                 ('g', 1),
                                 ('d', 0)]

    def test_compare_data(self, metrics_gather):
        results = metrics_gather.compare_data(DATA_PREVIOUS, DATA_CURRENT)
        assert results == DATA_RESULTS

    def test_plain_text(self, metrics_gather):
        plain_text = "\n".join(metrics_gather.plain_text(DATA_RESULTS))
        assert plain_text == """CVE STATUS USAGE - Non-Red Hat Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |             11 |
+------------+----------------+
|          c |              4 |
+------------+----------------+
|          f |              2 |
+------------+----------------+
|          g |              1 |
+------------+----------------+
|          d |              0 |
+------------+----------------+

CVE STATUS USAGE - All Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |             11 |
+------------+----------------+
|          c |              4 |
+------------+----------------+
|          f |              2 |
+------------+----------------+
|          a |              1 |
+------------+----------------+
|          e |              1 |
+------------+----------------+
|          g |              1 |
+------------+----------------+
|          d |              0 |
+------------+----------------+

CVE STATUS USAGE - Non-Red Hat Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |             13 |
+------------+----------------+
|          f |             11 |
+------------+----------------+
|          d |             10 |
+------------+----------------+
|          c |              5 |
+------------+----------------+
|          g |              1 |
+------------+----------------+

CVE STATUS USAGE - All Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |             13 |
+------------+----------------+
|          f |             11 |
+------------+----------------+
|          d |             10 |
+------------+----------------+
|          a |              8 |
+------------+----------------+
|          c |              5 |
+------------+----------------+
|          e |              2 |
+------------+----------------+
|          g |              1 |
+------------+----------------+

SYSTEM CVE STATUS USAGE - Non-Red Hat Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |              5 |
+------------+----------------+
|          f |              2 |
+------------+----------------+
|          c |              2 |
+------------+----------------+

SYSTEM CVE STATUS USAGE - All Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          b |              5 |
+------------+----------------+
|          f |              2 |
+------------+----------------+
|          c |              2 |
+------------+----------------+
|          a |              0 |
+------------+----------------+
|          e |             -2 |
+------------+----------------+

SYSTEM CVE STATUS USAGE - Non-Red Hat Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          f |             12 |
+------------+----------------+
|          b |             12 |
+------------+----------------+
|          c |             10 |
+------------+----------------+

SYSTEM CVE STATUS USAGE - All Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          f |             12 |
+------------+----------------+
|          b |             12 |
+------------+----------------+
|          c |             10 |
+------------+----------------+
|          a |             10 |
+------------+----------------+
|          e |              3 |
+------------+----------------+

CVE BUSINESS RISK USAGE - Non-Red Hat Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          d |              0 |
+------------+----------------+

CVE BUSINESS RISK USAGE - All Accounts Delta
+------------+----------------+
|    account |          count |
+------------+----------------+
|          d |              0 |
+------------+----------------+

CVE BUSINESS RISK USAGE - Non-Red Hat Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          d |             20 |
+------------+----------------+

CVE BUSINESS RISK USAGE - All Accounts Total
+------------+----------------+
|    account |          count |
+------------+----------------+
|          d |             20 |
+------------+----------------+
"""

    def test_html(self, metrics_gather):
        html = "\n".join(metrics_gather.html(DATA_RESULTS))
        assert html == """<h5>CVE STATUS USAGE - Non-Red Hat Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>11</td></tr>
<tr><td>c</td><td>4</td></tr>
<tr><td>f</td><td>2</td></tr>
<tr><td>g</td><td>1</td></tr>
<tr><td>d</td><td>0</td></tr>
</table>
<h5>CVE STATUS USAGE - All Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>11</td></tr>
<tr><td>c</td><td>4</td></tr>
<tr><td>f</td><td>2</td></tr>
<tr><td>a</td><td>1</td></tr>
<tr><td>e</td><td>1</td></tr>
<tr><td>g</td><td>1</td></tr>
<tr><td>d</td><td>0</td></tr>
</table>
<h5>CVE STATUS USAGE - Non-Red Hat Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>13</td></tr>
<tr><td>f</td><td>11</td></tr>
<tr><td>d</td><td>10</td></tr>
<tr><td>c</td><td>5</td></tr>
<tr><td>g</td><td>1</td></tr>
</table>
<h5>CVE STATUS USAGE - All Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>13</td></tr>
<tr><td>f</td><td>11</td></tr>
<tr><td>d</td><td>10</td></tr>
<tr><td>a</td><td>8</td></tr>
<tr><td>c</td><td>5</td></tr>
<tr><td>e</td><td>2</td></tr>
<tr><td>g</td><td>1</td></tr>
</table>
<h5>SYSTEM CVE STATUS USAGE - Non-Red Hat Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>5</td></tr>
<tr><td>f</td><td>2</td></tr>
<tr><td>c</td><td>2</td></tr>
</table>
<h5>SYSTEM CVE STATUS USAGE - All Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>b</td><td>5</td></tr>
<tr><td>f</td><td>2</td></tr>
<tr><td>c</td><td>2</td></tr>
<tr><td>a</td><td>0</td></tr>
<tr><td>e</td><td>-2</td></tr>
</table>
<h5>SYSTEM CVE STATUS USAGE - Non-Red Hat Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>f</td><td>12</td></tr>
<tr><td>b</td><td>12</td></tr>
<tr><td>c</td><td>10</td></tr>
</table>
<h5>SYSTEM CVE STATUS USAGE - All Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>f</td><td>12</td></tr>
<tr><td>b</td><td>12</td></tr>
<tr><td>c</td><td>10</td></tr>
<tr><td>a</td><td>10</td></tr>
<tr><td>e</td><td>3</td></tr>
</table>
<h5>CVE BUSINESS RISK USAGE - Non-Red Hat Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>d</td><td>0</td></tr>
</table>
<h5>CVE BUSINESS RISK USAGE - All Accounts Delta</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>d</td><td>0</td></tr>
</table>
<h5>CVE BUSINESS RISK USAGE - Non-Red Hat Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>d</td><td>20</td></tr>
</table>
<h5>CVE BUSINESS RISK USAGE - All Accounts Total</h5>
<table><tr><td>account</td><td>count</td></tr>
<tr><td>d</td><td>20</td></tr>
</table>"""

    # 2 of the following tests are commented out because the test data defined
    # in the test data script database/schema/ve_db_dev_data.sql is NOT
    # the actual data in the database when the unit tests run.
    #
    # def test_query_cve_status(self, pg_db_conn, metrics_gather):
    #     cve_status_usage = metrics_gather.query_cve_status_usage(pg_db_conn)
    #     assert cve_status_usage == [('2', 2), ('1', 1)]

    def test_query_system_cve_status(self, pg_db_conn, metrics_gather):
        system_cve_status_usage = metrics_gather.query_system_cve_status_usage(pg_db_conn)
        assert system_cve_status_usage == [('0', 32), ('1', 10)]

    # def test_query_cve_business_risk(self, pg_db_conn, metrics_gather):
    #     cve_business_risk_usage = metrics_gather.query_cve_business_risk_usage(pg_db_conn)
    #     assert cve_business_risk_usage == [('2', 3), ('1', 2)]
