"""Unit tests for refresh_handler"""
# pylint: disable=missing-docstring,too-many-public-methods,invalid-name

import pytest

from manager.base import ApplicationException
from manager.refresh_handler import Refresh
from .vuln_testcase import FlaskTestCase, ADMIN_URL_BASE


class TestRefreshHandler(FlaskTestCase):

    @staticmethod
    def test_none_args():
        # code is unreachabe using vfetch
        with pytest.raises(ApplicationException) as exc:
            Refresh._account_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

        with pytest.raises(ApplicationException) as exc:
            Refresh._cve_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

        with pytest.raises(ApplicationException) as exc:
            Refresh._system_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

    def test_refresh_account(self):
        self.vfetch('refresh/accounts/0', method='PUT', url_base=ADMIN_URL_BASE).check_response(401)
        self.vfetch('refresh/accounts/INVALID', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/accounts/0', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response()

    def test_refresh_account_cve(self):
        self.vfetch('refresh/accounts/0/cves/CVE-2014-1', method='PUT', url_base=ADMIN_URL_BASE).check_response(401)
        self.vfetch('refresh/accounts/INVALID/cves/INVALID', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/accounts/INVALID/cves/CVE-2014-1', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/accounts/0/cves/INVALID', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/accounts/0/cves/CVE-2014-1', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response()

    def test_refresh_cve(self):
        self.vfetch('refresh/cves/CVE-2014-1', method='PUT', url_base=ADMIN_URL_BASE).check_response(401)
        self.vfetch('refresh/cves/INVALID', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/cves/CVE-2014-1', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response()

    def test_refresh_system(self):
        self.vfetch('refresh/systems/00000000-0000-0000-0000-000000000002', method='PUT', url_base=ADMIN_URL_BASE).check_response(401)
        self.vfetch('refresh/systems/11111111-1111-1111-1111-000000000001', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response(404)
        self.vfetch('refresh/systems/00000000-0000-0000-0000-000000000002', turnpike=True, method='PUT', url_base=ADMIN_URL_BASE).check_response()
