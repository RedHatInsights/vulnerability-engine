"""Unit tests for refresh_handler"""
# pylint: disable=missing-docstring,too-many-public-methods,invalid-name

import pytest

from manager.base import ApplicationException
from manager.refresh_handler import Refresh
from .vuln_testcase import FlaskTestCase


class TestRefreshHandler(FlaskTestCase):

    @staticmethod
    def test_none_args():
        # code is unreachabe using vfetch
        with pytest.raises(ApplicationException) as exc:
            Refresh._account_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

        with pytest.raises(ApplicationException) as exc:
            Refresh._cve_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

        with pytest.raises(ApplicationException) as exc:
            Refresh._system_exists(None)  # pylint: disable=protected-access
        assert exc.value.status_code == 400

    def test_refresh_account(self):
        self.vfetch('refresh/accounts/0', method='PUT').check_response(403)
        self.vfetch('refresh/accounts/INVALID', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/accounts/0', internal_user=True, method='PUT').check_response()

    def test_refresh_account_cve(self):
        self.vfetch('refresh/accounts/0/cves/CVE-2014-1', method='PUT').check_response(403)
        self.vfetch('refresh/accounts/INVALID/cves/INVALID', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/accounts/INVALID/cves/CVE-2014-1', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/accounts/0/cves/INVALID', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/accounts/0/cves/CVE-2014-1', internal_user=True, method='PUT').check_response()

    def test_refresh_cve(self):
        self.vfetch('refresh/cves/CVE-2014-1', method='PUT').check_response(403)
        self.vfetch('refresh/cves/INVALID', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/cves/CVE-2014-1', internal_user=True, method='PUT').check_response()

    def test_refresh_system(self):
        self.vfetch('refresh/systems/INV-2', method='PUT').check_response(403)
        self.vfetch('refresh/systems/INVALID', internal_user=True, method='PUT').check_response(404)
        self.vfetch('refresh/systems/INV-2', internal_user=True, method='PUT').check_response()
