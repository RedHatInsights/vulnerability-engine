# -*- coding: utf-8 -*-
# pylint: disable=invalid-name
"""
Schemas of responses.
"""
from schema import Optional, Or, Schema

_meta = {
    "page": int,
    "page_size": int,
    "total_items": int,
    "pages": int,
    "sort": Or(None, str),
    "filter": Or(None, str),
    "offset": int,
    "limit": int,
    "data_format": str,
    "permissions": [str]
}

_meta_permissions = {
    "permissions": [str]
}

_links = {
    "first": str,
    "next": Or(None, str),
    "previous": Or(None, str),
    "last": str
}

_tags = {
    "namespace": str,
    "key": str,
    "value": Or(None, str)
}

_affected_system_attr = {
    "inventory_id": str,
    "insights_id": Or(None, str),
    "display_name": Or(None, str),
    "cve_status_id": int,
    "reporter": int,
    "rule": Or(None, {
        "details": dict,
        "resolution": {
            "resolution": Or(None, str),
        },
        "rule": {
            "description": Or(None, str),
            "more_info": Or(None, str),
            "node_id": Or(None, int),
            "reason": Or(None, str),
            "rule_id": str
        }
    }),
    "status_id": int,
    "status_name": str,
    "status_text": Or(None, str),
    "last_evaluation": Or(str, None),
    "rules_evaluation": Or(str, None),
    "tags": Or([_tags], []),
    "updated": Or(None, str),
    "os": str,
    "first_reported": str,
    "advisory_available": bool,
    "remediation": int,
    "culled_timestamp": Or(None, str),
    "stale_timestamp": Or(None, str),
    "stale_warning_timestamp": Or(None, str),
}

_affected_system_attr_with_advisories = {
    'advisories_list': Or([str], [])
}
_affected_system_attr_with_advisories.update(_affected_system_attr)

_affected_system = {
    "type": "system",
    "id": str,
    "attributes": Or(_affected_system_attr, _affected_system_attr_with_advisories)
}

_affected_system_ids = {
    'inventory_id': str,
    'rule_id': Or(str, None),
    'status_id': int,
    'status_text': Or(str, None),
}

_system = {
    "type": "system",
    "id": str,
    "attributes": {
        "inventory_id": str,
        "insights_id": Or(str, None),
        "rules_evaluation": Or(str, None),
        "cve_count": Or(None, int),
        "display_name": Or(None, str),
        "last_evaluation": Or(str, None),
        "opt_out": bool,
        "os": str,
        "last_upload": Or(None, str),
        "stale_timestamp": Or(None, str),
        "stale_warning_timestamp": Or(None, str),
        "culled_timestamp": Or(str, None),
        "tags": Or([_tags], []),
        "updated": Or(None, str)},
}

_systems_id = {
    "id": str,
    "opt_out": bool
}

_insights_rule = {
    'rule_id': str,
    'description': Or(str, None),
    'summary': Or(str, None),
    'reboot_required': Or(bool, None),
    'playbook_count': Or(int, None),
    'change_risk': Or(int, None),
    'kbase_node_id': Or(int, None),
    'associated_cves': Or([str], []),
    'rule_impact': Or(int, None),
    'publish_date': Or(str, None),
    Optional("systems_affected"): int,
}

_insights_system_rule = {
    'rule_id': str,
    'description': Or(str, None),
    'summary': Or(str, None),
    'reboot_required': Or(bool, None),
    'playbook_count': Or(int, None),
    'change_risk': Or(int, None),
    'kbase_node_id': Or(int, None),
}

_vulnerabilities_cve = {
    "type": "cve",
    "id": str,
    "attributes": {
        "business_risk": str,
        "business_risk_id": int,
        "business_risk_text": Or(None, str),
        "status": str,
        "status_id": int,
        "status_text": Or(None, str),
        "systems_affected": int,
        "synopsis": str,
        "public_date": Or(None, str),
        "impact": str,
        "description": str,
        "cvss2_score": Or(None, str),
        "cvss3_score": Or(None, str),
        "systems_status_divergent": int,
        "rules": Or([_insights_rule], []),
        "known_exploit": bool
    },
}

_vulnerabilities_cve_ids = {
    'business_risk_id': int,
    'business_risk_text': Or(str, None),
    'id': str,
    'status_id': int,
    'status_text': Or(str, None),
}

_vulnerabilities_cve_post = {
    "type": "cve",
    "id": str,
    "attributes": {
        "synopsis": str,
        "impact": str,
        "cvss_score": Or(None, str),
    },
}

_system_cve_attr = {
    "business_risk": str,
    "business_risk_id": int,
    "business_risk_text": Or(None, str),
    "synopsis": str,
    "public_date": Or(None, str),
    "impact": str,
    "description": str,
    "cvss2_score": Or(None, str),
    "cvss3_score": Or(None, str),
    "cve_status_id": int,
    "reporter": int,
    "rule": Or(None, _insights_system_rule),
    "status": str,
    "status_id": int,
    "status_text": Or(None, str),
    "cve_status_text": Or(None, str),
    "known_exploit": bool,
    "first_reported": str,
    "advisory_available": bool,
    "remediation": int,
}

_system_cves_rec_ids = {
    'id': str,
    'rule_id': Or(str, None),
    'status_id': int,
    'status_text': Or(str, None),
}

_system_cve_attr_with_advisories = {
    'advisories_list': Or([str], [])
}
_system_cve_attr_with_advisories.update(_system_cve_attr)

_system_cve = {
    "type": "cve",
    "id": str,
    "attributes": Or(_system_cve_attr, _system_cve_attr_with_advisories)
}

_vulnerabilities_meta = {
    "affecting": Or(None, str),
    "cvss_from": Or(None, float),
    "cvss_to": Or(None, float),
    "public_from": Or(None, str),
    "public_to": Or(None, str),
    "impact": Or(None, str),
    "business_risk_id": Or(None, str),
    "status_id": Or(None, str),
    "system_count": Or(None, int),
    "rule_presence": Or(None, str),
    "tags": Or(None, str),
    "sap_system": Or(None, bool),
    "sap_sids": Or(None, str),
    "known_exploit": Or(None, str),
    "rhel_version": Or(None, str),
}
_vulnerabilities_meta.update(_meta)

_advisory_details = {
    "attributes": {
        "advisory_type": int,
        "applicable_systems": int,
        "description": str,
        "public_date": str,
        "severity": int,
        "synopsis": str
    },
    "id": str,
    "type": str
}

_vmaas_cves_data = {
    "impact": str,
    "public_date": Or(None, str),
    "synopsis": str,
    "description": str,
    "modified_date": Or(None, str),
    Optional("redhat_url"): Or(None, str),
    Optional("cvss2_score"): Or(None, str),
    "cvss3_score": Or(None, str),
    Optional("secondary_url"): Or(None, str),
    Optional("cvss2_metrics"): Or(None, str),
    "cvss3_metrics": Or(None, str),
    "business_risk": str,
    "business_risk_id": int,
    "business_risk_text": Or(None, str),
    "status": str,
    "status_id": int,
    "status_text": Or(None, str),
    "systems_status_detail": dict,
    "systems_status_divergent": int,
    "rules": Or([_insights_rule], []),
    "advisories_list": Or(Or([Or(str, _advisory_details)], []), None),
    "celebrity_name": Or(None, str),
    "known_exploit": bool,
}

_system_meta = {
    "excluded": Or(None, str),
    "stale": Or(None, bool),
    "uuid": Or(None, str),
    "tags": Or(None, str),
    "sap_system": Or(None, bool),
    "sap_sids": Or(None, str),
    "rhel_version": Or(None, str),
    "ansible": Or(None, bool),
    "mssql": Or(None, bool),
}
_system_meta.update(_meta)

_system_cves_meta = {
    "cvss_from": Or(None, float),
    "cvss_to": Or(None, float),
    "public_from": Or(None, str),
    "public_to": Or(None, str),
    "impact": Or(None, str),
    "status_id": Or(None, str),
    "business_risk_id": Or(None, str),
    "rule_presence": Or(None, str),
    "patch_access": Or(None, bool),
    "show_advisories": Or(None, bool),
    "advisory": Or(None, str),
    "rule_key": Or(None, str),
    "known_exploit": Or(None, str),
    "first_reported_from": Or(None, str),
    "first_reported_to": Or(None, str),
    "advisory_available": Or(None, bool),
    "remediation": Or(None, int),
}
_system_cves_meta.update(_meta)

_system_details_data = {
    'insights_id': Or(str, None),
    'last_evaluation': Or(str, None),
    'rules_evaluation': Or(str, None),
    'opt_out': bool,
    'stale': bool,
    'last_upload': Or(None, str),
    'tags': Or([_tags], []),
    'updated': Or(None, str),
    'os': str,
}
_system_details = {
    "data": _system_details_data,
    "meta": _meta_permissions
}

_affected_systems_meta = {
    "status_id": Or(None, str),
    "uuid": Or(None, str),
    "rule_presence": Or(None, str),
    "rule_key": Or(None, str),
    "tags": Or(None, str),
    "sap_system": Or(None, bool),
    "sap_sids": Or(None, str),
    "patch_access": Or(None, bool),
    "show_advisories": Or(None, bool),
    "advisory": Or(None, str),
    "rhel_version": Or(None, str),
    "first_reported_from": Or(None, str),
    "first_reported_to": Or(None, str),
    "rule": Or(None, str),
    "advisory_available": Or(None, bool),
    "remediation": Or(None, int),
    "ansible": Or(None, bool),
    "mssql": Or(None, bool),
}
_affected_systems_meta.update(_meta)

_cve = {"data": {"attributes": _vmaas_cves_data, "id": str, "type": "cve", 'patch_access': Or(None, bool)}, "meta": _meta_permissions}

_vulnerabilities_cves = {"meta": _vulnerabilities_meta, "links": _links, "data": Or([_vulnerabilities_cve], [], str)}
_vulnerabilities_cves_ids = {"meta": _vulnerabilities_meta, "links": _links, "data": Or([_vulnerabilities_cve_ids], [], str)}
_vulnerabilities_cves_post = {"meta": _meta, "links": _links, "data": Or([_vulnerabilities_cve_post], [])}
_system_cves = {"meta": _system_cves_meta, "links": _links, "data": Or([_system_cve], [], str)}
_system_cves_ids = {"meta": _system_cves_meta, "links": _links, "data": Or([_system_cves_rec_ids], [], str)}
_systems = {"meta": _system_meta, "links": _links, "data": Or([_system], [], str)}
_systems_ids = {"meta": _system_meta, "links": _links, "data": Or([_systems_id], [], str)}
_affected_systems = {"meta": _affected_systems_meta, "links": _links, "data": Or([_affected_system], [], str)}
_affected_systems_ids = {"meta": _affected_systems_meta, "links": _links, "data": Or([_affected_system_ids], [], str)}

_bulk_change_data = {
    'updated': list
}

_bulk_change = {
    "meta": _meta_permissions
}
_bulk_change.update(_bulk_change_data)

_top_cve = {
    'cvss2_score': Or(None, str),
    'cvss3_score': Or(None, str),
    'description': str,
    'synopsis': str,
    'systems_affected': int,
    'security_rule': bool,
    'known_exploit': bool
}

_severity_data = {
    'count': int,
    'percentage': float
}

_dashboard_severity_data = {
    'count': int,
    'percentage': float,
    'known_exploits': int
}

_top_rule = {
    'associated_cves': Or([], [str]),
    'description': str,
    'name': str,
    'rule_id': str,
    'severity': int,
    'systems_affected': int,
}

_executive_report_data = {
    'cves_by_severity': {
        '0to3.9': _severity_data,
        '4to7.9': _severity_data,
        '8to10': _severity_data
    },
    'cves_total': int,
    'recent_cves': {
        'last7days': int,
        'last30days': int,
        'last90days': int
    },
    'system_count': int,
    'top_cves': Or([], [_top_cve]),
    'top_rules': Or([], [_top_rule]),
}

_executive_report = {
    "meta": _meta_permissions
}
_executive_report.update(_executive_report_data)

_recent_rule = {
    'associated_cves': Or([], [str]),
    'description': str,
    'name': str,
    'node_id': int,
    'severity': int,
    'systems_affected': int,
}

_dashboard = {
    'cves_by_severity': {
        '0to3.9': _dashboard_severity_data,
        '4to7.9': _dashboard_severity_data,
        '8to10': _dashboard_severity_data,
        'na': _dashboard_severity_data,
    },
    'cves_total': int,
    'system_count': int,
    'recent_cves': {
        'last7days': int,
        'last30days': int,
        'last90days': int
    },
    'recent_rules': Or([], [_recent_rule]),
    'rules_cves_total': int,
    "exploited_cves_count": int,
    "meta": _meta_permissions,
}

cve = Schema(_cve)
vulnerabilities_cves = Schema(_vulnerabilities_cves)
vulnerabilities_cves_ids = Schema(_vulnerabilities_cves_ids)
vulnerabilities_cves_post = Schema(_vulnerabilities_cves_post)
systems = Schema(_systems)
systems_ids = Schema(_systems_ids)
affected_systems = Schema(_affected_systems)
affected_systems_ids = Schema(_affected_systems_ids)
system_cves = Schema(_system_cves)
system_cves_ids = Schema(_system_cves_ids)
system_details = Schema(_system_details)
opt_out = Schema(_bulk_change)
business_risk = Schema(_bulk_change)
status = Schema(_bulk_change)
dashboard = Schema(_dashboard)


SCHEMA_MAP = {
    ("GET", "/v1/cves/.+/affected_systems/ids"): affected_systems_ids,
    ("GET", "/v1/cves/.+/affected_systems"): affected_systems,
    ("GET", "/v1/cves/CVE-"): cve,
    ("GET", "/v1/vulnerabilities/cves/ids"): vulnerabilities_cves_ids,
    ("GET", "/v1/vulnerabilities/cves"): vulnerabilities_cves,
    ("GET", "/v1/systems/.+/cves/ids"): system_cves_ids,
    ("GET", "/v1/systems/.+/cves"): system_cves,
    ("GET", "/v1/systems/ids"): systems_ids,
    ("GET", "/v1/systems/.+"): system_details,
    ("GET", "/v1/systems"): systems,
    ("PATCH", '/v1/systems/opt_out'): opt_out,
    ('PATCH', '/v1/cves/business_risk'): business_risk,
    ('PATCH', '/v1/cves/status'): status,
    ('GET', '/v1/dashboard'): dashboard,
    ('POST', '/v1/vulnerabilities/cves'): vulnerabilities_cves_post,
}
