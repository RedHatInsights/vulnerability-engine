# -*- coding: utf-8 -*-
# pylint: disable=invalid-name
"""
Schemas of responses.
"""
from schema import Optional, Or, Schema

_meta = {
    "page": int,
    "page_size": int,
    "total_items": int,
    "pages": int,
    "sort": Or(None, str),
    "filter": Or(None, str),
    "offset": int,
    "limit": int,
    "data_format": str,
}

_links = {
    "first": str,
    "next": Or(None, str),
    "previous": Or(None, str),
    "last": str
}

_affected_system = {
    "type": "system",
    "id": str,
    "attributes": {
        "inventory_id": str,
        "status_id": int,
        "status_name": str,
        "last_evaluation": str,
    },
}

_system = {
    "type": "system",
    "id": str,
    "attributes": {"inventory_id": str,
                   "cve_count": Or(None, int), "last_evaluation": str, "opt_out": bool},
}

_vulnerabilities_cve = {
    "type": "cve",
    "id": str,
    "attributes": {
        "systems_affected": int,
        "synopsis": str,
        "public_date": str,
        "impact": str,
        "description": str,
        "cvss2_score": str,
        "cvss3_score": str,
    },
}

_system_cve = {
    "type": "cve",
    "id": str,
    "attributes": {
        "synopsis": str,
        "public_date": str,
        "impact": str,
        "description": str,
        "cvss2_score": str,
        "cvss3_score": str,
        "status": str,
        "status_id": int,
    },
}

_vulnerabilities_meta = {
    "show_all": Or(None, bool),
    "cvss_from": Or(None, float),
    "cvss_to": Or(None, float),
    "public_from": Or(None, str),
    "public_to": Or(None, str),
    "impact": Or(None, str),
}
_vulnerabilities_meta.update(_meta)

_vmaas_cves_data = {
    "impact": str,
    "public_date": str,
    "synopsis": str,
    "description": str,
    "modified_date": str,
    Optional("redhat_url"): str,
    Optional("cvss2_score"): str,
    "cvss3_score": str,
    Optional("secondary_url"): str,
    "cwe_list": [str],
    "errata_list": [str],
    "package_list": [str],
    Optional("cvss2_metrics"): str,
    "cvss3_metrics": str,
}

_system_meta = {
    "opt_out": Or(None, bool)
}
_system_meta.update(_meta)

_system_cves_meta = {
    "cvss_from": Or(None, float),
    "cvss_to": Or(None, float),
    "public_from": Or(None, str),
    "public_to": Or(None, str),
    "impact": Or(None, str),
    "status_id": Or(None, str),
    "opt_out": bool
}
_system_cves_meta.update(_meta)

_system_details = {
    'data': {
        'last_evaluation': str,
        'opt_out': bool,
    }
}

_affected_systems_meta = {
    "status_id": Or(None, str)
}
_affected_systems_meta.update(_meta)

_cve = {"data": {"attributes": _vmaas_cves_data, "id": str, "type": "cve"}, "meta": {}}


_vulnerabilities_cves = {"meta": _vulnerabilities_meta, "links": _links, "data": Or([_vulnerabilities_cve], [], str)}
_system_cves = {"meta": _system_cves_meta, "links": _links, "data": Or([_system_cve], [], str)}
_systems = {"meta": _system_meta, "links": _links, "data": Or([_system], [], str)}
_affected_systems = {"meta": _affected_systems_meta, "links": _links, "data": Or([_affected_system], [], str)}
_impacts = {"Important": int, "Moderate": int, "Critical": int, "Low": int}
_changes = {
    "since": Or(str, None),
    "new_vulnerabilities": {"count": int, "percentage": int, "direction": str},
    "remediated": {"count": int, "percentage": int, "direction": str},
    "newly_affected": {"count": int, "percentage": int, "direction": str},
}

cve = Schema(_cve)
vulnerabilities_cves = Schema(_vulnerabilities_cves)
systems = Schema(_systems)
affected_systems = Schema(_affected_systems)
system_cves = Schema(_system_cves)
system_details = Schema(_system_details)
impacts = Schema(_impacts)
changes = Schema(_changes)


SCHEMA_MAP = {
    ("GET", "/v1/cves/.+/affected_systems"): affected_systems,
    ("GET", "/v1/cves/CVE-"): cve,
    ("GET", "/v1/vulnerabilities/cves"): vulnerabilities_cves,
    ("GET", "/v1/systems/.+/cves"): system_cves,
    ("GET", "/v1/systems/.+"): system_details,
    ("GET", "/v1/systems"): systems,
    ("GET", "/v1/vulnerabilities/impacts"): impacts,
    ("GET", "/v1/vulnerabilities/changes"): changes,
}
