# -*- coding: utf-8 -*-
# pylint:disable=missing-docstring
import pytest
from peewee import PostgresqlDatabase

from common import database_handler, peewee_database

from ..utils import restore_db

peewee_database.DB = PostgresqlDatabase(None)

POSTGRESQL_USER = "ve_db_user_manager"
POSTGRESQL_PASSWORD = "ve_db_user_manager_pwd"


@pytest.fixture(scope="session", autouse=True)
def peewee_db(pg_db_session):
    """Initializes database for peewee."""
    database = peewee_database.DB
    db_env = pg_db_session.dsn()

    database.init(
        db_env["database"], user=POSTGRESQL_USER, password=POSTGRESQL_PASSWORD, host=db_env["host"], port=db_env["port"]
    )

    return database


@pytest.fixture(scope='module', autouse=True)
def module_cleanup(request):
    def db_cleanup():
        restore_db(database_handler.pg_testing)
    request.addfinalizer(db_cleanup)
