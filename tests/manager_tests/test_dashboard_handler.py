"""Unit tests for report handler"""

# pylint: disable=missing-docstring
import pytest

from .vuln_testcase import FlaskTestCase


@pytest.mark.feature_flag("vulnerability.cves_without_errata")
class TestDashboardHandler(FlaskTestCase):
    def test_dashboard(self):
        report = self.vfetch("dashboard").check_response()
        assert report.body.cves_total == 16
        assert report.body.cves_by_severity["0to3.9"]["count"] == 2
        assert report.body.cves_by_severity["4to7.9"]["count"] == 9
        assert report.body.cves_by_severity["4to7.9"]["known_exploits"] == 2
        assert report.body.cves_by_severity["8to10"]["count"] == 5
        assert report.body.rules_cves_total == 8

    def test_dashboard_tags(self):
        report = self.vfetch("dashboard?tags=vulnerability/usage=NAS").check_response()
        assert report.body.cves_total == 9
        assert report.body.cves_by_severity["0to3.9"]["count"] == 2
        assert report.body.cves_by_severity["4to7.9"]["count"] == 5
        assert report.body.cves_by_severity["4to7.9"]["known_exploits"] == 2
        assert report.body.cves_by_severity["8to10"]["count"] == 2
        assert report.body.rules_cves_total == 7

    def test_dashboard_sap_system(self):
        report = self.vfetch("dashboard?sap_system=true").check_response()
        assert report.body.cves_total == 16
        assert report.body.cves_by_severity["0to3.9"]["count"] == 2
        assert report.body.cves_by_severity["4to7.9"]["count"] == 9
        assert report.body.cves_by_severity["4to7.9"]["known_exploits"] == 2
        assert report.body.cves_by_severity["8to10"]["count"] == 5
        assert report.body.rules_cves_total == 8

    def test_dashboard_sap_system_and_tags(self):  # pylint: disable=invalid-name
        report = self.vfetch("dashboard?sap_system=true&tags=vulnerability/usage=server").check_response()
        assert report.body.cves_total == 13
        assert report.body.cves_by_severity["0to3.9"]["count"] == 0
        assert report.body.cves_by_severity["4to7.9"]["count"] == 9
        assert report.body.cves_by_severity["4to7.9"]["known_exploits"] == 2
        assert report.body.cves_by_severity["8to10"]["count"] == 4
        assert report.body.rules_cves_total == 7

    def test_dashboard_sap_sid(self):
        report = self.vfetch("dashboard?sap_sids=xxee").check_response()
        assert report.body.cves_total == 0
        assert report.body.cves_by_severity["0to3.9"]["count"] == 0
        assert report.body.cves_by_severity["4to7.9"]["count"] == 0
        assert report.body.cves_by_severity["4to7.9"]["known_exploits"] == 0
        assert report.body.cves_by_severity["8to10"]["count"] == 0
        assert report.body.rules_cves_total == 0
