"""Unit tests for cve_handler"""
# pylint: disable=missing-docstring,too-many-public-methods,invalid-name

from .vuln_testcase import FlaskTestCase


class TestCveHandler(FlaskTestCase):

    def test_cves_affected_systems(self):
        response = self.vfetch("cves/CVE-2016-1/affected_systems").check_response()
        assert len(response.body.data) == 3
        response = self.vfetch("cves/CVE-2016-1/affected_systems/ids").check_response()
        assert len(response.body.data) == 3

    def test_cves_affected_systems_st_1(self):
        self.vfetch("cves/CVE-2016-1/affected_systems?status_id=2,nan").check_response(status_code=400)
        self.vfetch("cves/CVE-2016-1/affected_systems/ids?status_id=2,nan").check_response(status_code=400)

    def test_cves_affected_systems_st_2(self):
        response = self.vfetch("cves/CVE-2016-1/affected_systems?status_id=1").check_response()
        assert not response.body.data
        response = self.vfetch("cves/CVE-2016-1/affected_systems/ids?status_id=1").check_response()
        assert not response.body.data

    def test_cves_affected_systems_st_3(self):
        response = self.vfetch("cves/CVE-2016-1/affected_systems?status_id=4,5,6").check_response()
        assert len(response.body.data) == 1
        response = self.vfetch("cves/CVE-2016-1/affected_systems/ids?status_id=4,5,6").check_response()
        assert len(response.body.data) == 1

    def test_invalid_cves_affected_systems(self):
        self.vfetch("cves/CVE-INVALID/affected_systems").check_response(status_code=404)
        self.vfetch("cves/CVE-INVALID/affected_systems/ids").check_response(status_code=404)

    def test_cve_details(self):
        assert self.vfetch('cves/CVE-2016-1').status_code == 200

    def test_unknown_cve_details(self):
        assert self.vfetch('cves/TOTALLY-NOT-A-CVE').status_code == 404

    def test_cve_has_rules(self):
        response = self.vfetch('cves/CVE-2017-8').check_response()
        assert len(response.body.data.attributes.rules) == 2
        assert response.body.data.attributes.rules[0].associated_cves == ['CVE-2017-8', 'CVE-2018-1']

    def test_cves_affected_systems_rule_filter(self):
        response = self.vfetch('cves/CVE-2017-8/affected_systems?security_rule=true').check_response()
        assert len(response.body.data) == 2
        response = self.vfetch('cves/CVE-2017-8/affected_systems/ids?security_rule=true').check_response()
        assert len(response.body.data) == 2
        response = self.vfetch('cves/CVE-2017-8/affected_systems?security_rule=false').check_response()
        assert len(response.body.data) == 1
        response = self.vfetch('cves/CVE-2017-8/affected_systems/ids?security_rule=false').check_response()
        assert len(response.body.data) == 1

        response = self.vfetch(
                        'cves/CVE-2017-8/affected_systems?security_rule=CVE_2018_12130_cpu_kernel|CVE_2018_12130_CPU_KERNEL_BAD_MICROCODE').check_response()
        assert len(response.body.data) == 1

        response = (self.vfetch('cves/CVE-2017-8/affected_systems/ids?security_rule=CVE_2018_12130_cpu_kernel|CVE_2018_12130_CPU_KERNEL_BAD_MICROCODE')
                    .check_response())
        assert len(response.body.data) == 1
