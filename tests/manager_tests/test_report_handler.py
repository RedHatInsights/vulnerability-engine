"""Unit tests for report handler"""
# pylint: disable=missing-docstring,too-many-public-methods,invalid-name
import json

import pytest

from .vuln_testcase import FlaskTestCase
from common.feature_flags import EDGE_PARITY_FEATURE


DEFAULT_RETVAL = {
    "system_count": 0,
    "system_count_per_type": {"rpmdnf": 0},
    "cves_total": 0,
    "cves_by_severity": {
        "0to3.9": {"count": 0, "percentage": 0, "known_exploit_count": 0},
        "4to7.9": {"count": 0, "percentage": 0, "known_exploit_count": 0},
        "8to10": {"count": 0, "percentage": 0, "known_exploit_count": 0},
        "na": {"count": 0, "percentage": 0, "known_exploit_count": 0},
    },
    "recent_cves": {"last7days": 0, "last30days": 0, "last90days": 0},
    "rules_total": 0,
    "rules_by_severity": {
        "1": {"rule_count": 0, "systems_affected": 0},
        "2": {"rule_count": 0, "systems_affected": 0},
        "3": {"rule_count": 0, "systems_affected": 0},
        "4": {"rule_count": 0, "systems_affected": 0},
    },
    "top_cves": [],
    "top_rules": [],
    "meta": {"permissions": ["vulnerability:*:*", "inventory:hosts:read"]},
}


@pytest.mark.feature_flag("vulnerability.cves_without_errata")
class TestReportHandler(FlaskTestCase):
    def test_executive_report(self):
        report = self.vfetch("report/executive").check_response()
        assert report.body.system_count == 18
        assert report.body.system_count_per_type.rpmdnf == 18
        assert report.body.cves_total == 15
        assert report.body.top_cves[0].synopsis == "CVE-2017-1"
        assert report.body.top_cves[0].systems_affected == 3
        assert report.body.top_cves[0].cvss3_score == "9.900"
        assert (
            report.body.rules_total
            == 5
            == sum([report.body.rules_by_severity[item]["rule_count"] for item in report.body.rules_by_severity])
        )
        assert report.body.top_rules[0].systems_affected == 2
        assert report.body.top_rules[1].systems_affected == 2
        assert report.body.top_rules[2].systems_affected == 1

    @pytest.mark.feature_flag(EDGE_PARITY_FEATURE)
    def test_executive_report_with_edge(self):
        report = self.vfetch("report/executive").check_response()
        assert report.body.system_count_per_type.rpmdnf == 18
        assert report.body.system_count_per_type.edge == 2
        assert report.body.system_count == (report.body.system_count_per_type.rpmdnf + report.body.system_count_per_type.edge)
        assert report.body.cves_total == 16
        assert (
            report.body.rules_total
            == 5
            == sum([report.body.rules_by_severity[item]["rule_count"] for item in report.body.rules_by_severity])
        )
        assert report.body.top_rules[0].systems_affected == 2
        assert report.body.top_rules[1].systems_affected == 2
        assert report.body.top_rules[2].systems_affected == 1

    def test_executive_report_no_org(self):
        response = self.raw_get(
            "/api/vulnerability/v1/report/executive",
            headers=self._make_header({"identity": {"account_number": "666"}, "entitlements": {"insights": {"is_entitled": True}}}),
        ).check_response()
        assert json.loads(response.data) == DEFAULT_RETVAL

    def test_executive_report_no_systems(self):
        response = self.raw_get(
            "/api/vulnerability/v1/report/executive",
            headers=self._make_header({"identity": {"org_id": "3"}, "entitlements": {"insights": {"is_entitled": True}}}),
        ).check_response()
        assert json.loads(response.data) == DEFAULT_RETVAL

    def test_executive_report_no_vuln(self):
        response = self.raw_get(
            "/api/vulnerability/v1/report/executive",
            headers=self._make_header({"identity": {"org_id": "2"}, "entitlements": {"insights": {"is_entitled": True}}}),
        ).check_response()
        expected_retval = DEFAULT_RETVAL.copy()
        expected_retval["system_count_per_type"]["rpmdnf"] = 1
        expected_retval["system_count"] = 1
        assert json.loads(response.data) == expected_retval

    def test_executive_report_known_exploits(self):
        """Test known exploits report"""
        report = self.vfetch("report/executive").check_response()
        assert report.body.cves_by_severity["8to10"].known_exploit_count == 0
        assert map(lambda cve: not cve["known_exploit"], report.body.top_cves)
