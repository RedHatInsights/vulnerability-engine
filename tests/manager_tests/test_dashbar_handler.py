"""
Dashbar tests
"""

import pytest

from .vuln_testcase import FlaskTestCase


@pytest.mark.feature_flag("vulnerability.cves_without_errata")
class TestDashbarHandler(FlaskTestCase):
    """Dashbar tests suite"""

    def test_dashbar(self):
        """Test dashbar"""
        res = self.vfetch("dashbar").check_response()
        assert res.body.exploitable_cves == 2
        assert res.body.critical_cves == 5
        assert res.body.cves_with_rule == 8
        assert res.body.important_cves == 6

    def test_dashbar_tags(self):
        """Test dashbar with tags filter"""
        res = self.vfetch("dashbar?tags=vulnerability/usage=NAS").check_response()
        assert res.body.exploitable_cves == 2
        assert res.body.critical_cves == 1
        assert res.body.cves_with_rule == 7
        assert res.body.important_cves == 6

    def test_dashbar_sap_system(self):
        """Test dashbar with sap systems"""
        res = self.vfetch("dashbar?sap_system=true").check_response()
        assert res.body.exploitable_cves == 2
        assert res.body.critical_cves == 5
        assert res.body.cves_with_rule == 8
        assert res.body.important_cves == 6

    def test_dashbar_sap_ids(self):
        """Test dashbar with sap ids"""
        res = self.vfetch("dashbar?sap_sids=xxee").check_response()
        assert res.body.exploitable_cves == 0
        assert res.body.critical_cves == 0
        assert res.body.cves_with_rule == 0
        assert res.body.important_cves == 0
