"""
Unit tests for delete_systems taskomatic job
"""

from common.database_handler import DatabasePoolConnection
import taskomatic.jobs.delete_systems as ds


class TestDeleteSystems():
    """
    Class holding all tests
    """

    @staticmethod
    def test_delete_stsrems(pg_db_conn, monkeypatch):
        """Test the deletion of obsolete systems"""
        cur = pg_db_conn.cursor()
        cur.execute("""SELECT count(id) from system_platform sp""")
        all_systems = cur.fetchone()[0]
        assert all_systems == 33
        cur.execute("""SELECT count(id) from system_platform sp
                    WHERE when_deleted IS NOT NULL""")
        to_delete = cur.fetchone()[0]
        assert to_delete == 3

        with DatabasePoolConnection() as conn:
            monkeypatch.setattr(ds, 'get_conn', lambda: conn)
            ds.run()

        cur.execute("""SELECT count(id) from system_platform sp""")
        after_deletion = cur.fetchone()[0]

        assert all_systems - to_delete == after_deletion
