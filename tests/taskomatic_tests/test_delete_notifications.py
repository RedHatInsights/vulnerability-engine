"""
Unit tests for delete_notifications taskomatic job
"""
import taskomatic.jobs.delete_notifications as dn
from common.database_handler import DatabasePoolConnection


class TestDeleteNotifications:
    """Class holding tests"""

    @staticmethod
    def test_delete(pg_db_conn, monkeypatch):
        """Test deleting old notifications, keeping the exploits"""
        cur = pg_db_conn.cursor()
        cur.execute("""INSERT INTO notified_accounts VALUES (0, 0, 'any-cve-known-exploit'),
                                                            (0, 0, 'new-cve-cvss'),
                                                            (0, 0, 'new-cve-severity'),
                                                            (0, 0, 'new-cve-security-rule')""")
        cur.execute("""INSERT INTO notified_accounts VALUES (0, 1, 'any-cve-known-exploit'),
                                                            (0, 1, 'new-cve-cvss'),
                                                            (0, 1, 'new-cve-severity')""")
        pg_db_conn.commit()

        with DatabasePoolConnection() as conn:
            monkeypatch.setattr(dn, "get_conn", lambda: conn)
            dn.run()

        cur.execute("""SELECT COUNT(*) FROM notified_accounts""")
        res = cur.fetchone()
        assert res[0] == 2
        cur.execute("""DELETE FROM notified_accounts""")

    @staticmethod
    def test_delete_empty(pg_db_conn, monkeypatch):
        """Test deleting none notifications"""
        cur = pg_db_conn.cursor()
        cur.execute("""INSERT INTO notified_accounts VALUES (0, 0, 'any-cve-known-exploit'),
                                                            (0, 1, 'any-cve-known-exploit')""")
        pg_db_conn.commit()
        cur.execute("""SELECT COUNT(*) FROM notified_accounts""")
        og_len = cur.fetchone()[0]

        with DatabasePoolConnection() as conn:
            monkeypatch.setattr(dn, "get_conn", lambda: conn)
            dn.run()

        cur.execute("""SELECT COUNT(*) FROM notified_accounts""")
        new_len = cur.fetchone()[0]
        assert new_len == og_len
        cur.execute("""DELETE FROM notified_accounts""")
