# pylint: disable=no-self-use
"""
Unit tests fortaskomatic
"""

from psycopg2.extensions import connection
from tornado.testing import AsyncHTTPTestCase

import taskomatic.jobs.common as tjc
from taskomatic import taskomatic

TASKOMATIC_JOBS = ["db_metrics", "delete_systems", "rules_git_sync", "stale_systems", "usage_metrics"]


class TestTaskomatic:
    """
    Class holding all tests
    """

    @staticmethod
    def test_get_conn(monkeypatch, pg_db_mod):
        """Test obtaining DB connection"""
        class CustomCFG:
            """Custom config class to override DB config with"""

            def __init__(self, pg_db_mod):
                dsn = pg_db_mod.dsn()
                self.db_name = dsn['database']
                self.db_user = dsn['user']
                self.db_pass = None
                self.db_host = dsn['host']
                self.db_port = dsn['port']
                self.db_ssl_mode = 'disable'
                self.db_ssl_root_cert_path = '/dev/null'

        custom_cfg = CustomCFG(pg_db_mod)
        monkeypatch.setattr(tjc, 'CFG', custom_cfg)

        conn = tjc.get_conn()
        assert isinstance(conn, connection)
        assert conn.closed == 0

        cur = conn.cursor()
        cur.execute("""SELECT COUNT(*) FROM system_platform""")
        res = cur.fetchone()[0]
        assert res == 20

        cur.close()
        conn.close()

        assert conn.closed == 1

    def test_main(self, monkeypatch):
        """Test main, job and taskomatic setup"""
        # Setup to not loop the tests
        monkeypatch.setattr(taskomatic.SCHEDULER, "start", lambda: None)
        monkeypatch.setattr(taskomatic.MAIN_LOOP, "start", lambda: None)
        taskomatic.JOBS = "stale_systems:5,delete_systems:30".split(",")

        taskomatic.main()

        jobs = taskomatic.SCHEDULER.get_jobs()
        for job in jobs:
            assert job.id in TASKOMATIC_JOBS


class TestTaskomaticApp(AsyncHTTPTestCase):
    """Test taskomatic App handlers"""

    def get_app(self):
        return taskomatic.APP

    def test_run_job(self):
        """Test run job handler"""
        response = self.fetch("/api/v1/run/stale_systems", method="PUT", body="{}")
        assert response.code == 200

    def test_run_job_wrong(self):
        """Test run job handler with wrong job"""
        response = self.fetch("/api/v1/run/nonexisting_job", method="PUT", body="{}")
        assert response.code == 404
