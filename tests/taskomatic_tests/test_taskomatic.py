"""
Unit tests fortaskomatic
"""

from psycopg2.extensions import connection

import taskomatic.jobs.common as tjc


class TestTaskomatic:
    """
    Class holding all tests
    """

    @staticmethod
    def test_get_conn(monkeypatch, pg_db_mod):
        """Test obtaining DB connection"""
        class CustomCFG:
            """Custom config class to override DB config with"""

            def __init__(self, pg_db_mod):
                dsn = pg_db_mod.dsn()
                self.db_name = dsn['database']
                self.db_user = dsn['user']
                self.db_pass = None
                self.db_host = dsn['host']
                self.db_port = dsn['port']
                self.db_ssl_mode = 'disable'
                self.db_ssl_root_cert_path = '/dev/null'

        custom_cfg = CustomCFG(pg_db_mod)
        monkeypatch.setattr(tjc, 'CFG', custom_cfg)

        conn = tjc.get_conn()
        assert isinstance(conn, connection)
        assert conn.closed == 0

        cur = conn.cursor()
        cur.execute("""SELECT COUNT(*) FROM system_platform""")
        res = cur.fetchone()[0]
        assert res == 19

        cur.close()
        conn.close()

        assert conn.closed == 1
