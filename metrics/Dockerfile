FROM registry.access.redhat.com/ubi8/ubi-minimal

RUN microdnf install python3 which shadow-utils && microdnf clean all

WORKDIR /metrics

ADD /metrics/Pipfile*    /metrics/

ENV LC_ALL=C.utf8
ENV LANG=C.utf8
RUN pip3 install --upgrade pipenv && \
    pipenv install --ignore-pipfile --deploy --system && ln -s /usr/bin/python3 /usr/bin/python && pipenv check --system

RUN adduser --gid 0 -d /metrics --no-create-home insights

USER insights

ADD /common/*.py             /metrics/common/
ADD /metrics/*.py            /metrics/metrics/

CMD python3 -m metrics.metrics_gather
