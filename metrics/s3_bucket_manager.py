"""
Manage metrics raw data storage in S3 buckets.
"""

import io
import json
import boto3

from common.config import Config


class S3BucketManager():
    """S3 Bucket Manager"""

    def __init__(self, debug=False):
        self.cfg = Config()
        self.debug = debug
        self.s3_client = boto3.client(
            's3',
            endpoint_url=self.cfg.s3_endpoint_url,
            aws_access_key_id=self.cfg.s3_aws_access_key_id,
            aws_secret_access_key=self.cfg.s3_aws_secret_access_key,
        )

    def list_keys(self):
        """Get the list of keys for data in the bucket."""
        key_list = []
        response = self.s3_client.list_objects_v2(Bucket=self.cfg.s3_bucket)
        if 'Contents' in response:
            for content in response['Contents']:
                key_list.append(content['Key'])
        if self.debug:
            print("Keys in bucket %s: %s" % (self.cfg.s3_bucket, key_list))
        return key_list

    def upload_data(self, key, data):
        """Upload the given data to the S3 bucket with the given key."""
        fileobj = io.BytesIO(json.dumps(data).encode('utf-8'))
        if self.debug:
            print("Uploading %s to bucket %s" % (key, self.cfg.s3_bucket))
        self.s3_client.upload_fileobj(fileobj, self.cfg.s3_bucket, key)

    def retrieve_data(self, key):
        """Retrieve the data associated with the given key."""
        if self.debug:
            print("Retrieving %s from bucket %s" % (key, self.cfg.s3_bucket))
        bytesio = io.BytesIO()
        self.s3_client.download_fileobj(self.cfg.s3_bucket, key, bytesio)
        data = json.loads(bytesio.getvalue().decode('utf-8'))
        return data

    def delete_by_key(self, key):
        """Delete the data associated with the given key."""
        if self.debug:
            print("Deleting %s from bucket %s" % (key, self.cfg.s3_bucket))
        self.s3_client.delete_object(Bucket=self.cfg.s3_bucket, Key=key)

    def delete_by_key_list(self, key_list):
        """Delete the data associated with each of the provided keys."""
        if self.debug:
            print("Deleting the following keys from bucket %s" % self.cfg.s3_bucket)
        object_list = []
        for key in key_list:
            if self.debug:
                print(key)
            object_list.append({'Key': key})
        self.s3_client.delete_objects(Bucket=self.cfg.s3_bucket,
                                      Delete={'Objects': object_list,
                                              'Quiet': True})
