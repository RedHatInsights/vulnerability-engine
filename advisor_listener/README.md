# Vulnerability Engine Advisor Listener

## Overview
Advisor listener is consuming the results coming from Insights Engine.
Insights Engine is performing a Vulnerability analysis on system uploaded to inventory more deeply (ex.: from modules, settings...).
Results from engine are in form of rules.
Each CVE can have `0-N` associated rules and each rule can be associated with `1-N` CVEs.
Each system can then have only `0-1` rule related to the CVE.

## Incoming message
The message is really long and contains a lot of info, we portrait only the important ones for vulnerability.
* In vulnerability we call the `reports` section of report (`type=rule`) the rule hit.
Rule hit is a result of rule which identifies minimum of `1` CVE to which system is vulnerable.
We call full rule hit the result of the rule which identified system as vulnerable to exactly all `N` rule CVEs.
Otherwise this we call it partial rule hit (or partial rule pass, this is interchagable).
* The `pass` section of report (`type=pass`) we call rule passes. Rule pass is a result of rule which identifies that system is vulnerable to exactly `0` cves.

```
{
     "input": {
          "platform_metadata": {
               <platform metadata section similar to inventory message>
          },
          "host": {
               <system info>
          },
     },
     "results": {
          "system": {
               <other sytem metadata>
          }
     }
     "reports": [
          {
               "rule_id": <id of the rule in form of <rule name|error key>>,
               "key": <error key>,
               "type": "rule",
               "details": {
                    "cves": {
                         <cve>: <boolean or string, false if vulnerable to cve, otherwise message why system is not vulnerable>,
                    },
                    "type": "rule",
                    "error_key": <reason why is it rule hit>
               },
               "system_id": <inventory id of system>
          }
     ],
     "pass": [
          {
               "pass_id": <id of the rule in form of <rule name|All cves passed.>>,
               "key": "All cves passed."
               "type": "pass",
               "details": {
                    "cves": {
                         <cve>: <mitigation reason, why system is not vulnerable to this cve>,
                    },
                    "type": "pass",
                    "pass_key": "All CVEs passed.",
               }
               "system_id": <inventory id of system>
          }
     ]
}
```
Example
```
{
    "input": {
        "platform_metadata": {
            "account": "1",
            "org_id": 1,
            <more info>
        },
        "host": {
            "updated": "2020-07-29T16:01:56.018232+00:00",
            "stale_timestamp": "2020-07-30T18:01:55.966480+00:00",
            "culled_timestamp": "2020-08-13T18:01:55.966480+00:00",
            "account": "1",
            "stale_warning_timestamp": "2020-08-06T18:01:55.966480+00:00",
            "id": "b91fb018-a0d1-4a25-ba5c-62238e2629bd",
            "insights_id": "9989481-1111-2555-86a3-42eb30d01f74",
            "tags": [],
            "display_name": "test",
            "created": "2020-07-29T16:01:56.018227+00:00",
            <more info>
        },
        <more info>
    },
    "results": {
        "system": {
             <various system metadata>
        },
        "reports": [
            {
                "rule_id": "CVE_2018_12130_cpu_kernel|CVE_2018_12130_CPU_KERNEL_NEED_UPDATE",
                "type": "rule",
                "key": "CVE_2018_12130_CPU_KERNEL_NEED_UPDATE",
                "details": {
                    "cves": {
                        "CVE-2018-12126": false,
                        "CVE-2018-12130": false,
                        "CVE-2018-12127": false,
                        "CVE-2019-11091": "This kernel is not vulnerable"
                    },
                    "type": "rule",
                    "error_key": "CVE_2018_12130_CPU_KERNEL_NEED_UPDATE"
                },
                "system_id": "84489481-3333-2222-1111-42eb30d01f74",
                <more info>
            }
        ],
        "pass": [
            {
                "pass_id": "CVE_2017_5753_4_cpu_kernel|All CVEs passed.",
                "type": "pass",
                "key": "All CVEs passed.",
                "details": {
                    "cves": {
                        "CVE-2017-5753": "The current combination and configuration of the CPU and kernel is not vulnerable.",
                        "CVE-2017-5715": "The current combination and configuration of the CPU and kernel is not vulnerable.",
                        "CVE-2017-5754": "The current combination and configuration of the CPU and kernel is not vulnerable."
                    },
                    "type": "pass",
                    "pass_key": "All CVEs passed."
                },
                "system_id": "84489481-3333-2222-1111-42eb30d01f74",
                <more info>
            },
        ],
    }
}
```

## Design
Advisor listener is consuming the `platform.engine.results` topic where each message is a result of evaluation of single system.
Single message consists from array of rule passes and hits.
Pass or hit is a result of rule investigation on given system.
Listener parses these passes and hits, and based on already existing rule results in database it changes the vulnerability results (`system_vulnerabilities` and `insights_rule` table).
* If CVE key inside of rule hit has string value - update the reason why cve is not vulnerable in db and link rule to CVE-system link, system is not vulnerable to the CVE anymore
* If CVE key inside of rule hit has false boolean - remove reason in db and link rule to CVE-system link, system is vulnerable to the CVE
* If CVE key is inside of rule pass - update the reason why cve is not vulnerable in db and link rule to CVE-system link, system is not vulnerable to the CVE anymore
* If linked rule ID is in database but not in result - remove the rule link from CVE-system link

Also this listener is updating the CVE system count cache and sends the results to the Notificator kafka topic `vulnerability.evaluator.results`.
### Possible outcomes
Because vulnerability has two sources of analysis, there is a need to specify their combinations.
For package vulnerability analysis (VMaaS - Listener) vulnerability has `when_mitigated` field in `system_vulnerabilities` table, which signifies when VMaaS first time registred this system as NOT vulnerable to this CVE.
For rule vulnerability analysis (adivsor listener) vulnerability has `rule_id` foreign key in `system_vulnerabilities` table which references to the `insights_rule` table and `mitigation_reason` which signifies why the rule thinks that the system is not vulnerable to the CVE.
Rule analysis has always precedence before the package analysis because its more precise.
Now there can be multiple combinations of this results together, which we need to present to the customer:
* Affected and vulnerable - System has installed vulnerable package (VMaaS hit) and there is a rule hit or partial rule hit for some CVE
* Affected but not vulnerable - System has installed vulnerable package (VMaaS hit) and there is a rule pass or partial rule hit but the CVE value is set `false`
* Not affected but vulnerable - System does not have installed vulnerable package (VMaaS pass) and there is a rule hit or partial rule hit for some CVE

# `parse_inventory_data(upload_data: dict)` return values:

## `(advisor_json, rule_hits)`:
---


`advisor_json: str`
```js
{
     "rule_hits": {
          "id": "CVE_2018_rpm|CVE_2018_131131_64664_rpm",
          "CVE-2014-1": {
               "cve_name": "CVE-2014-1",
               "details": {
                    "rhel-version": 8,
                    "cves": { "CVE-2014-1": false, "CVE-2018-2": false },
                    "type": "rule",
                    "error_key": "CVE_2018_131131_64664_rpm"
               }
          }
     },
     ...
}
```
---

`rule_hits: Dict[str, Dict[...]]`
```py
{
     "CVE-2014-1": {
          "id": "CVE_2018_rpm|CVE_2018_131131_64664_rpm",
          "cve_name": "CVE-2014-1",
          "details": {
               "rhel-version": 8,
               "cves": { "CVE-2014-1": False, "CVE-2018-2": False },
               "type": "rule",
               "error_key": "CVE_2018_131131_64664_rpm"
          }
     },
     ...
}
```

