#!/bin/bash

RELEASE_NAMESPACE="${RELEASE_NAMESPACE:-}"
SKIP_DEPLOY_EPHEMERAL="${SKIP_DEPLOY_EPHEMERAL:-}"
SKIP_IMAGE_BUILD="${SKIP_IMAGE_BUILD:-}"
SKIP_SMOKE_TEST="${SKIP_SMOKE_TEST:-}"

_get_pr_labels() {
    curl -s -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/redhatinsights/vulnerability-engine/issues/${ghprbPullId}/labels"
}

set_label_flags() {

    local PR_LABELS

    if ! PR_LABELS=$(_get_pr_labels); then
        echo "Error retrieving PR labels"
        return 1
    fi

    if grep -E 'keep-namespace' <<< "$PR_LABELS"; then
        RELEASE_NAMESPACE='false'
        echo "Namespace will not be released"
    fi

    if grep -E 'skip-build' <<< "$PR_LABELS"; then
        SKIP_IMAGE_BUILD='true'
        echo "Image will not be built"
    fi

    if grep -E 'skip-deploy' <<< "$PR_LABELS"; then
        SKIP_DEPLOY_EPHEMERAL='true'
        echo "deployment to ephemeral skipped"
    fi

    if grep -E 'skip-tests' <<< "$PR_LABELS"; then
        SKIP_SMOKE_TEST='true'
        echo "Smoke tests will be skipped"
    fi
}

_process_requirements_labels() {
    # $1 env var to export
    # $@ labels to process
    env_var_name=$1; shift;
    labels=$@
    if [ -n "$labels" ]; then
        labels=$(echo "$labels" | sed -e 's/"//g')
        # contents of labels is different in different shells
        # it can be one of
        #   labels="REQ1\nREQ2"
        #   labels="REQ1 REQ2"
        lines=$(echo "$labels" | wc -l | xargs)
        words=$(echo "$labels" | wc -w | xargs)
        if [[ "$lines" == "1" ]] && [[ "$words" == "1" ]]; then
            export "$env_var_name=$labels"
            return
        fi
        processed=""
        for req in $labels; do
            processed="$processed$req,"
        done
        # delete extra comma
        processed="${processed%?}"
        export "$env_var_name=$processed"
    fi
}

process_requirements_labels() {
    if [ -f $LABELS_DIR/github_labels.txt ]; then
        requirements=$(egrep "^\"[A-Z]+-[A-Z-]*\"$" $LABELS_DIR/github_labels.txt)
        requirements_priority=$(egrep "^\"(critical|high|medium|low)-requirements\"$" $LABELS_DIR/github_labels.txt | sed -e 's/-requirements//g')
        _process_requirements_labels IQE_REQUIREMENTS $requirements
        _process_requirements_labels IQE_REQUIREMENTS_PRIORITY $requirements_priority
    fi
}
