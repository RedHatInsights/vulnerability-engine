#!/bin/bash

WORKSPACE=${WORKSPACE:-$PWD}
JUNIT_REPORT_GENERATOR="${WORKSPACE}/junit-report-generator.sh"

function get_pr_labels() {
    _github_api_request "issues/$ghprbPullId/labels" | jq '.[].name'
}

function set_label_flags() {

    local PR_LABELS

    if ! PR_LABELS=$(get_pr_labels); then
        echo "Error retrieving PR labels"
        return 1
    fi

    if ! grep -E 'lgtm|pr-check-build|.*smoke-tests|ok-to-skip-smokes' <<< "$PR_LABELS"; then
        SKIP_PR_CHECK='true'
        EXIT_CODE=1
        echo "PR check skipped"
    elif grep -E 'ok-to-skip-smokes' <<< "$PR_LABELS"; then
        SKIP_PR_CHECK='true'
        echo "smokes not required"
    elif ! grep -E '.*smoke-tests' <<< "$PR_LABELS"; then
        echo "WARNING! No smoke-tests labels found!, PR smoke tests will be skipped"
        SKIP_SMOKE_TESTS='true'
        EXIT_CODE=2
    elif _set_IQE_filter_expressions_for_smoke_labels "$PR_LABELS"; then
        echo "Smoke tests will run"
    else
        echo "Error setting IQE filters from PR_LABELS: $PR_LABELS"
        SKIP_SMOKE_TESTS='true'
        EXIT_CODE=2
    fi
}

function build_image() {
    export DOCKER_BUILDKIT=1
    source $CICD_ROOT/build.sh
}

function is_pull_request() {
    [[ -n "$ghprbPullId" ]]
}

function run_smoke_tests_stage() {
    echo "running PR smoke tests"
    set +e
    process_requirements_labels
    set -e
    run_smoke_tests
}

function generate_junit_report_from_code() {

    local CODE="$1"

    mkdir -p "$ARTIFACTS_DIR"
    "$JUNIT_REPORT_GENERATOR" "$CODE" > "${ARTIFACTS_DIR}/junit-pr_check.xml"
}

_github_api_request() {

    local API_PATH="$1"
    curl -s -H "Accept: application/vnd.github.v3+json" "${GITHUB_API_ROOT}/$API_PATH"
}

function latest_commit_in_pr() {

    local LATEST_COMMIT

    if ! LATEST_COMMIT=$(_github_api_request "pulls/$ghprbPullId" | jq -r '.head.sha'); then
        echo "Error retrieving PR information"
    fi

    [[ "$LATEST_COMMIT" == "$ghprbActualCommit" ]]
}

function _install_bonfire_tools() {

    CICD_URL=https://raw.githubusercontent.com/RedHatInsights/bonfire/master/cicd
    curl -s "${CICD_URL}/bootstrap.sh" > .cicd_bootstrap.sh && source "${WORKSPACE}/.cicd_bootstrap.sh"
}

function run_build_image_stage() {
    
    _install_bonfire_tools
    echo "creating PR image"
    build_image
}

function deploy_ephemeral_stage() {
    _install_bonfire_tools
    echo "deploying ephemeral environment"
    source $CICD_ROOT/deploy_ephemeral_env.sh
}

function configure_stages() {

    if ! is_pull_request; then
        echo "Error, no PR information found, is this invoked from a PR?"
        SKIP_PR_CHECK='true'
        EXIT_CODE=1
        return
    fi

    # check if this commit is out of date with the branch
    if ! latest_commit_in_pr; then
        SKIP_PR_CHECK='true'
        EXIT_CODE=3
        return
    fi

    if ! set_label_flags; then
        echo "Error setting up workflow based on PR labels"
        SKIP_PR_CHECK='true'
        EXIT_CODE=1
    fi
}

##############################################################################################

function _process_requirements_labels() {
    # $1 env var to export
    # $@ labels to process
    env_var_name=$1; shift;
    labels=$@
    if [ -n "$labels" ]; then
        labels=$(echo "$labels" | sed -e 's/"//g')
        # contents of labels is different in different shells
        # it can be one of
        #   labels="REQ1\nREQ2"
        #   labels="REQ1 REQ2"
        lines=$(echo "$labels" | wc -l | xargs)
        words=$(echo "$labels" | wc -w | xargs)
        if [[ "$lines" == "1" ]] && [[ "$words" == "1" ]]; then
            export "$env_var_name=$labels"
            return
        fi
        processed=""
        for req in $labels; do
            processed="$processed$req,"
        done
        # delete extra comma
        processed="${processed%?}"
        export "$env_var_name=$processed"
    fi
}

function process_requirements_labels() {
    if [ -f $LABELS_DIR/github_labels.txt ]; then
        requirements=$(egrep "^\"[A-Z]+-[A-Z-]*\"$" $LABELS_DIR/github_labels.txt)
        requirements_priority=$(egrep "^\"(critical|high|medium|low)-requirements\"$" $LABELS_DIR/github_labels.txt | sed -e 's/-requirements//g')
        _process_requirements_labels IQE_REQUIREMENTS $requirements
        _process_requirements_labels IQE_REQUIREMENTS_PRIORITY $requirements_priority
    fi
}