# Vulnerability Engine Notificator Service

## Overview
Notificator sends notifications to customer.
Both Evaluator and Advisor listener sends results of the evaluations to the notificator, which based on given conditions send new notifications to the Notifications service, which propagates the notifications to Splunk and Email based on customer settings.

## Design
Notificator is consuming the `vulnerability.evaluator.results` where Evaluator and Advisor listener are providing results of the system evaluations.
Message contains:
```
{
    "rh_account_id": <internal db account id>,
    "account_number": <rh account number of customer>,
    "org_id": <rh org id of customer>,
    "new_system_vulnerabilities_ids": <internal id of new system-cve links in system_vulnerabilities table>,
    "mitigated_system_vulnerabilities_ids": <internal id of new mitigated system-cve links in system_vulnerabilities table>,
    "unmitigated_system_vulnerabilities_ids": <internal id of new unmitigated system-cve links in system_vulnerabilities table>
}
```
Notificator on each new message calculates the new notifications (`NotificatorConditions`, `NotificationType`) which should be sent to the customer and puts the results into a notificator queue (`NotificatorQueue`), single item (`QueueItem`) in queue contains:
```
cve: cve name
cve_id: internal db id of cve
rh_account_id: internal db account id
account_number: rh account number of customer
org_id: rh org id of customer
notif_events: array of notification types, to which customer should be notified
```
There are two queues, the unknown cves queue and known cves queue.
Since we have both sources of data, where the results can be mutually exclusive (vmaas can mark system as vulnerable to cve, but advisor listener can set it as non vulnerable) the notificator queue resolver needs to wait for evaluation from both components.
Queue resolver process runs every 3 minutes and checks both queues, for normal cve queue:
* Checks if `system_vulnerabilities` id row exists.
* Checks if system is fully evaluated, if system was not fully evaluated after 5 minutes it still proceeds.
* Checks if system vulnerability was not mitigated already by another evaluator component.
* Checks if customer was already notified about this CVE.

If all checks passes, notification is sent to the Notifications platform through kafka on `platform.notifications.ingress` topic.
More about the notifications message can be found [here](https://consoledot.pages.redhat.com/notifications-docs/dev/user-guide/send-notification.html).

For the unknown CVE queue, resolver performs steps:
* Checks if CVE is already in our database

If checks pass, queue item `QueueItem` is passed from unknown CVE queue to normal queue.

### Developing

Currently, we only sent notification for a CVE to customer only once.
This information is cached inside of the `notified_accounts` table.
To restart the notifications cache for given account, a developer needs to call the endpoint inside of the manager admin component `DELETE /v1/notifications/{org_id}`.
