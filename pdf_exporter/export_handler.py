"""
Module for /export API endpoint
"""

import asyncio
from http.cookies import SimpleCookie

import connexion
from pyppeteer import launch
from pyppeteer.errors import PageError

from common.logging import get_logger
from .base import GetRequest

LOGGER = get_logger(__name__)

DEFAULT_CLOUD_HOST = "cloud.redhat.com"


class GetExportedPdf(GetRequest):
    """GET to /v1/export"""

    _endpoint_name = r'/v1/version'

    @classmethod
    async def _export_pdf(cls, url, jwt):
        browser = await launch(args=["--no-sandbox"])
        page = await browser.newPage()
        cookie = {
            "name": "cs_jwt",
            "domain": ".redhat.com",
            "secure": True,
            "value": jwt
        }
        await page.setCookie(cookie)
        try:
            await page.goto(url, {"waitUntil": "networkidle2"})
        except PageError as exc:
            LOGGER.exception("Error when accessing page '%s': ", url)
            return str(exc), 400

        pdf_bytes = await page.pdf({"format": "A4"})
        await browser.close()
        return pdf_bytes, 200

    @classmethod
    def handle_get(cls, **kwargs):  # pylint: disable=unused-argument
        """Return exported PDF."""
        cookie = SimpleCookie(connexion.request.headers.get("Cookie", ""))
        jwt = getattr(cookie.get("cs_jwt", ""), "value", "")
        if not jwt:
            msg = "Invalid Cookie Header."
            LOGGER.warning(msg)
            return GetRequest.format_exception(msg, 401)

        cloud_host = connexion.request.headers.get("X-Forwarded-Host")
        if not cloud_host:
            LOGGER.warning("Missing X-Forwarded-Host header, using '%s'.", DEFAULT_CLOUD_HOST)
            cloud_host = DEFAULT_CLOUD_HOST

        path = kwargs["path"]
        url = "https://%s/%s" % (cloud_host, path)
        result, status = asyncio.get_event_loop().run_until_complete(cls._export_pdf(url, jwt))
        if status == 200:
            return result, 200  # return PDF bytes
        return GetRequest.format_exception("Unable to export PDF: %s" % result, status)
