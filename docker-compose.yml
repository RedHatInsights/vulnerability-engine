version: '3'

services:
  ve_database:
    container_name: vulnerability-engine-database
    build:
        context: ./
        dockerfile: ./Dockerfile-database
    image: vulnerability-engine/database:latest
    restart: unless-stopped
    env_file:
      - ./conf/database-connection-admin.env
    ports:
      - 15432:5432
    volumes:
      - vulnerability-engine-db-data:/var/lib/pgsql/data

  ve_evaluator:
    container_name: vulnerability-engine-evaluator
    build:
      context: ./
      dockerfile: ./Dockerfile-evaluator
    image: vulnerability-engine/evaluator:latest
    restart: unless-stopped
    env_file:
      - ./conf/database-connection-evaluator.env
      - ./conf/kafka-connection-evaluator.env
      - ./conf/evaluator.env
    ports:
      - "8085:8085"
    depends_on:
      - ve_database
      - ve_kafka

  ve_listener:
    container_name: vulnerability-engine-listener
    build:
        context: ./
        dockerfile: ./Dockerfile-listener
    image: vulnerability-engine/listener:latest
    restart: unless-stopped
    env_file:
      - ./conf/listener.env
      - ./conf/database-connection-listener.env
    ports:
      - "8200:8000"
      - "8086:8086"
    depends_on:
      - ve_database
      - ve_kafka

  ve_manager:
    container_name: vulnerability-engine-manager
    build:
      context: ./
      dockerfile: ./Dockerfile-manager
    image: vulnerability-engine/manager:latest
    restart: unless-stopped
    env_file:
      - ./conf/database-connection-manager.env
      - ./conf/manager.env
    ports:
      - 8300:8443
    depends_on:
      - ve_database

  ve_kafka:
    container_name: vulnerability-kafka
    build:
        context: ./
        dockerfile: ./Dockerfile-kafka

    image: vulnerability-engine/kafka:latest
    restart: unless-stopped
    ports:
      - 9092:9092

  ve_apidoc:
    container_name: vulnerability-engine-apidoc
    build:
      context: ./
      dockerfile: ./Dockerfile-apidoc
    image: vulnerability-engine/apidoc:latest
    restart: unless-stopped
    env_file:
      - ./conf/apidoc.env
    ports:
      - 8000:8080
    depends_on:
      - ve_manager

volumes:
  vulnerability-engine-db-data:
