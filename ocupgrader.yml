tasks:
  maintenance-mode:
    description: Switch application to maintenance mode
    commands:
      - description: Scale down vulnerability-engine-vmaas-sync
        args: ["scale", "dc", "vulnerability-engine-vmaas-sync", "--replicas=0"]
      - description: Scale down vulnerability-engine-listener
        args: ["scale", "dc", "vulnerability-engine-listener", "--replicas=0"]
      - description: Scale down vulnerability-engine-evaluator-recalc
        args: ["scale", "dc", "vulnerability-engine-evaluator-recalc", "--replicas=0"]
      - description: Scale down vulnerability-engine-evaluator-upload
        args: ["scale", "dc", "vulnerability-engine-evaluator-upload", "--replicas=0"]
      - description: Scale vulnerability-engine-manager to single pod
        args: ["scale", "dc", "vulnerability-engine-manager", "--replicas=1"]
      - description: Set read-only mode in vulnerability-engine-manager to TRUE
        args: ["patch", "dc", "vulnerability-engine-manager", "-p", '{"spec": {"template": {"spec": {"containers": [{"name": "vulnerability-engine-manager", "env": [{"name": "READ_ONLY_MODE", "value": "TRUE"}]}]}}}}']
      
  operational-mode:
    description: Switch application to operational mode
    commands:
      - description: Set read-only mode in vulnerability-engine-evaluator-upload to FALSE
        args: ["patch", "dc", "vulnerability-engine-manager", "-p", '{"spec": {"template": {"spec": {"containers": [{"name": "vulnerability-engine-manager", "env": [{"name": "READ_ONLY_MODE", "value": "FALSE"}]}]}}}}']
      - description: Scale up vulnerability-engine-manager
        args: ["scale", "dc", "vulnerability-engine-manager", "--replicas=3"]
      - description: Scale up vulnerability-engine-evaluator-upload
        args: ["scale", "dc", "vulnerability-engine-evaluator-upload", "--replicas=1"]
      - description: Scale up vulnerability-engine-evaluator-recalc
        args: ["scale", "dc", "vulnerability-engine-evaluator-recalc", "--replicas=1"]
      - description: Scale up vulnerability-engine-listener
        args: ["scale", "dc", "vulnerability-engine-listener", "--replicas=10"]
      - description: Scale up vulnerability-engine-vmaas-sync
        args: ["scale", "dc", "vulnerability-engine-vmaas-sync", "--replicas=1"]

  status:
    description: Return status of the application
    commands:
      - description: Print info about Build Configs
        args: ["get", "bc", "-o", "custom-columns=BUILDCONFIG:.metadata.name,SOURCE BRANCH:.spec.source.git.ref,OUTPUT IMAGESTREAM:.spec.output.to.name"]
      - description: Print info about Image Streams
        args: ["get", "is", "-o", "custom-columns=IMAGESTREAM:.metadata.name,TAGS:.status.tags[*].tag"]
      - description: Print info about Deployment Configs
        args: ["get", "dc", "-o", "custom-columns=DEPLOYMENTCONFIG:.metadata.name,PODS:.status.replicas,IMAGESTREAM:.spec.triggers[*].imageChangeParams.from.name"]
      - description: Get vulnerability-engine-manager read-only mode
        args: ["get", "dc", "vulnerability-engine-manager", "-o", "custom-columns=DEPLOYMENTCONFIG:.metadata.name,READ-ONLY MODE:.spec.template.spec.containers[*].env[?(@.name=='READ_ONLY_MODE')].value"]

  upgrade-builds:
    parameters:
      - version
    description: Re-build images into new imagestream tag
    commands:
      - description: Patch vulnerability-engine-vmaas-sync Build Config
        args: ["patch", "bc", "vulnerability-engine-vmaas-sync", "-p", '{"spec": {"output": {"to": {"name": "vulnerability-engine-vmaas-sync:{{ version }}"}}}}']
      - description: Trigger vulnerability-engine-vmaas-sync build
        args: ["start-build", "vulnerability-engine-vmaas-sync"]
      - description: Patch vulnerability-engine-listener Build Config
        args: ["patch", "bc", "vulnerability-engine-listener", "-p", '{"spec": {"output": {"to": {"name": "vulnerability-engine-listener:{{ version }}"}}}}']
      - description: Trigger vulnerability-engine-listener build
        args: ["start-build", "vulnerability-engine-listener"]
      - description: Patch vulnerability-engine-evaluator Build Config
        args: ["patch", "bc", "vulnerability-engine-evaluator", "-p", '{"spec": {"output": {"to": {"name": "vulnerability-engine-evaluator:{{ version }}"}}}}']
      - description: Trigger vulnerability-engine-evaluator build
        args: ["start-build", "vulnerability-engine-evaluator"]
      - description: Patch vulnerability-engine-manager Build Config
        args: ["patch", "bc", "vulnerability-engine-manager", "-p", '{"spec": {"output": {"to": {"name": "vulnerability-engine-manager:{{ version }}"}}}}']
      - description: Trigger vulnerability-engine-manager build
        args: ["start-build", "vulnerability-engine-manager"]

  upgrade-services:
    parameters:
      - version
    description: Switch services to use new version images
    commands:
      - description: Patch vulnerability-engine-manager Deployment Config
        args: ["patch", "dc", "vulnerability-engine-manager", "-p", '{"spec": {"triggers": [{"type": "ImageChange", "imageChangeParams": {"containerNames": ["vulnerability-engine-manager"], "from": {"name": "vulnerability-engine-manager:{{ version }}"}}}]}}']
      - description: Patch vulnerability-engine-vmaas-sync Deployment Config
        args: ["patch", "dc", "vulnerability-engine-vmaas-sync", "-p", '{"spec": {"triggers": [{"type": "ImageChange", "imageChangeParams": {"containerNames": ["vulnerability-engine-vmaas-sync"], "from": {"name": "vulnerability-engine-vmaas-sync:{{ version }}"}}}]}}']
      - description: Patch vulnerability-engine-listener Deployment Config
        args: ["patch", "dc", "vulnerability-engine-listener", "-p", '{"spec": {"triggers": [{"type": "ImageChange", "imageChangeParams": {"containerNames": ["vulnerability-engine-listener"], "from": {"name": "vulnerability-engine-listener:{{ version }}"}}}]}}']
      - description: Patch vulnerability-engine-evaluator-recalc Deployment Config
        args: ["patch", "dc", "vulnerability-engine-evaluator-recalc", "-p", '{"spec": {"triggers": [{"type": "ImageChange", "imageChangeParams": {"containerNames": ["vulnerability-engine-evaluator-recalc"], "from": {"name": "vulnerability-engine-evaluator:{{ version }}"}}}]}}']
      - description: Patch vulnerability-engine-evaluator-upload Deployment Config
        args: ["patch", "dc", "vulnerability-engine-evaluator-upload", "-p", '{"spec": {"triggers": [{"type": "ImageChange", "imageChangeParams": {"containerNames": ["vulnerability-engine-evaluator-upload"], "from": {"name": "vulnerability-engine-evaluator:{{ version }}"}}}]}}']
