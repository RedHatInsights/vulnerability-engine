#/bin/bash

USAGE="Usage:
$0 [SETTINGS_YAML]

Optional parameters:
  SETTINGS_YAML - path to directory with test settings (default: conf/settings.local.yaml)
"

if [[ "$#" -gt 1 ]]; then
    echo "$USAGE" >&2
    exit 1
fi

[ "$(docker-compose ps | wc -l)" -gt  2 ] && docker-compose down
cp conf/common.env conf/common.env.bak
sed -i 's|VMAAS_HOST=http://vmaas_webapp:8080|VMAAS_HOST=https://webapp-vmaas-stable.1b13.insights.openshiftapps.com|' conf/common.env
docker-compose up -d --build
count=60
while [ "$count" -gt 0 ]; do
    engine_state=$(docker-compose ps | grep 'vulnerability-engine-manager' | awk '{print $4}')
    [ "$engine_state" = "Up" ] && break
    echo "Vulnerability-engine-manager is not Up, waiting 5s"
    ((count--))
    sleep 5
done
[ "$count" -gt 0 ] || exit 1

docker pull quay.io/cloudservices/iqe-tests:latest

if [ -n "$1" ]; then
    settings="$1"
else
    settings="conf/settings.local.yaml"
fi

docker run --name iqe --rm --network host \
    -v $(readlink -f $settings):/iqe_settings/settings.local.yaml:z \
    -e IQE_TESTS_LOCAL_CONF_PATH=/iqe_settings \
    -e ENV_FOR_DYNACONF=dev \
    quay.io/cloudservices/iqe-tests:latest \
    iqe tests plugin vulnerability -k 'rest and not basic_auth and not csaw' -v --local

mv conf/common.env.bak conf/common.env
