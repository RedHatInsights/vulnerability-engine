#!/bin/bash

GIT_DOCS="db_docs"
VE_DB_SCHEMA="ve_db_postgresql.sql"
VE_DB_MASTER="./db_docs/ve_database_master"
VE_DB_STABLE="./db_docs/ve_database_stable"
ORIGINAL_CSUM="dbscript_csum"
DB_DOCS_OUTPUT="output"
TEMP_CSUM="new_csum"

if [[ "$BRANCH_NAME" != "master" ]] && [[ "$BRANCH_NAME" != "stable" ]]
then
    echo "Database schema is updated only on pushes into master/stable."
    exit 0
fi

if [[ "$VULNERABILITY_DOCS_TOKEN" == "" ]]
then
    echo "Cannot find github token for pushing into docs repo."
    exit 1
fi

echo "Current branch of git: ${BRANCH_NAME}"

echo "Calculating checksum for ${VE_DB_SCHEMA}"
cd scripts
git clone https://github.com/RedHatInsights/vulnerability-docs.git $GIT_DOCS
sha1sum ../database/schema/$VE_DB_SCHEMA > $TEMP_CSUM
DIFF_RESULT=0

if [[ "$BRANCH_NAME" == "stable" ]]
then
    diff $TEMP_CSUM $VE_DB_STABLE/$ORIGINAL_CSUM > /dev/null
    DIFF_RESULT=$?
else
    diff $TEMP_CSUM $VE_DB_MASTER/$ORIGINAL_CSUM > /dev/null
    DIFF_RESULT=$?
fi

if [[ "$DIFF_RESULT" == "1" ]]
then
    echo "Commit has new changes in schema, regenerating docs"
    echo "Creating output directory for docs"
    mkdir $DB_DOCS_OUTPUT
    sudo chmod -R 777 $DB_DOCS_OUTPUT

    echo "Starting schemaspy container and creating docs"
    cd ..
    sudo systemctl stop postgresql.service
    docker-compose -f docker-compose-dbdocs.yml up --build schema_spy

    echo "Stopping containers"
    docker container stop vulnerability-engine-database
    sudo systemctl start postgresql.service

    echo "Moving the schema image"
    cd scripts
    sudo chmod -R 777 $DB_DOCS_OUTPUT
    if [[ "$BRANCH_NAME" == "stable" ]]
    then
        COMMIT_MESSAGE="Updating VE stable docs for commit $(git rev-parse --short HEAD)"
        rm -rf $VE_DB_STABLE/*
        mv ./$DB_DOCS_OUTPUT/* $VE_DB_STABLE
        mv -f $TEMP_CSUM $VE_DB_STABLE/$ORIGINAL_CSUM
    else
        COMMIT_MESSAGE="Updating VE master docs for commit $(git rev-parse --short HEAD)"
        rm -rf $VE_DB_MASTER/*
        mv ./$DB_DOCS_OUTPUT/* $VE_DB_MASTER
        mv -f $TEMP_CSUM $VE_DB_MASTER/$ORIGINAL_CSUM
    fi

    git config --global user.name "vmaas-bot"
    git config --global user.email "40663028+vmaas-bot@users.noreply.github.com"

    GIT_LOCATION="https://vmaas-bot:${VULNERABILITY_DOCS_TOKEN}@github.com/RedHatInsights/vulnerability-docs.git"

    cd $GIT_DOCS
    git add .
    git commit -m "$COMMIT_MESSAGE"
    git push "$GIT_LOCATION"

    cd ..
    rm -rf $DB_DOCS_OUTPUT
else
    echo "Schema is unchanged, done."
    rm $TEMP_CSUM
fi

rm -rf $GIT_DOCS
