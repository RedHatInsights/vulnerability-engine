#!/bin/sh

# This script runs the dbupgrade script in local development.
# You can specify your OCI runtime as first argument if not docker.
# Second argument can be the name of the specific container
# where must be dbupgrade.sh script.
# Script must be started from root directory, where the docker-compose
# yaml is located.

if [[ "$1" == "" ]]; then
    OCI=docker
else
    OCI=$1
fi

if [[ "$2" == "" ]]; then
    CONTAINER=vulnerability-engine-manager
else
    CONTAINER=$2
fi

STARTED=0

if [[ $($OCI ps -f "name=$CONTAINER" --format '{{.Names}}') != $CONTAINER ]]; then
    echo "Container is not running, starting compose"
    $OCI-compose up -d --build
    STARTED=1
fi

$OCI exec -e POSTGRESQL_USER=ve_db_admin \
          -e POSTGRESQL_PASSWORD=ve_db_admin_pwd \
          -it $CONTAINER ./dbupgrade.sh

if [[ "$STARTED" == 1 ]]; then
    $OCI-compose down
fi
