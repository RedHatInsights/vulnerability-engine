#!/usr/bin/bash

# Initialize local development database with data, cyndi inventory schema and more.
# Needs to be run on initialized vulnerability DB (usually ba running dbupgrade.sh)

function psql_exec {
    PGPASSWORD="${POSTGRES_PASSWORD}" psql --no-password -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USER}" -d "${POSTGRES_DB}" -t -f "$1"
}

# wait for postgres to be up
until pg_isready -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USER}" -d "${POSTGRES_DB}";
do sleep 2;
done

# Try to initialize local schema, if there is not a cyndi scheme
EXISTING_TABLES=$(echo "select 1 from information_schema.views where table_name = 'hosts' and table_schema = 'inventory'" | psql_exec - | sed 's/[[:space:]]//g')
RETVAL=$?
if [[ "$RETVAL" == "0" && "$EXISTING_TABLES" != "1" ]]; then
    echo "Initializing cyndi."
    psql_exec ./database/schema/ve_db_dev_cyndi.sql

    echo "Inserting mock data."
    psql_exec ./database/schema/ve_db_dev_data.sql
fi
