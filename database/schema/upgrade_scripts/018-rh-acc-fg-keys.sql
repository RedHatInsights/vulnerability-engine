-- system_platform table
ALTER TABLE system_platform ADD COLUMN rh_account_id INT;
UPDATE system_platform sp SET rh_account_id = sub.id FROM (SELECT id, name FROM rh_account) AS sub WHERE sp.rh_account = sub.name;
ALTER TABLE system_platform ALTER rh_account_id SET NOT NULL;
ALTER TABLE system_platform ADD CONSTRAINT rh_account_id FOREIGN KEY (rh_account_id) REFERENCES rh_account(id);
CREATE INDEX ON system_platform(rh_account_id);

-- cve_affected_systems_cache
ALTER TABLE cve_affected_systems_cache ADD COLUMN rh_account_id INT;
UPDATE cve_affected_systems_cache casc SET rh_account_id = sub.id FROM (SELECT id, name FROM rh_account) AS sub WHERE casc.rh_account = sub.name;
ALTER TABLE cve_affected_systems_cache ALTER rh_account_id SET NOT NULL;
ALTER TABLE cve_affected_systems_cache ADD CONSTRAINT rh_account_id FOREIGN KEY (rh_account_id) REFERENCES rh_account(id);
ALTER TABLE cve_affected_systems_cache ADD CONSTRAINT cve_affected_systems_cache_cve_id_rh_account_id_key UNIQUE (cve_id, rh_account_id);
CREATE INDEX ON cve_affected_systems_cache(rh_account_id);
