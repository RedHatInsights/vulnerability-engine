CREATE OR REPLACE FUNCTION delete_system(inventory_id_in UUID)
  RETURNS TABLE (deleted_inventory_id UUID) AS
$delete_system$
  DECLARE
    system_id_in INT;
    rh_account_id_in INT;
  BEGIN
    -- opt out to refresh cache and then delete
    SELECT id, rh_account_id FROM system_platform WHERE inventory_id = inventory_id_in INTO system_id_in, rh_account_id_in FOR UPDATE;
    UPDATE system_platform SET opt_out = true WHERE id = system_id_in;
    DELETE FROM system_vulnerabilities WHERE system_id = system_id_in AND rh_account_id = rh_account_id_in;
    DELETE FROM system_vulnerable_package WHERE system_id = system_id_in AND rh_account_id = rh_account_id_in;
    DELETE FROM system_repo WHERE system_id = system_id_in;
    RETURN QUERY DELETE FROM system_platform WHERE id = system_id_in RETURNING inventory_id;
  END;
$delete_system$
  LANGUAGE 'plpgsql';

GRANT SELECT, DELETE ON system_vulnerable_package TO ve_db_user_taskomatic;
GRANT SELECT, DELETE ON system_vulnerable_package TO ve_db_user_manager;
