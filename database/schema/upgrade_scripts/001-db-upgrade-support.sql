-- ----------------------------------------------------------------------------
-- db upgrade support
--
-- This upgrade script adds the tables required for db upgrade support.
-- ----------------------------------------------------------------------------

-- create db_version table
CREATE TABLE db_version (
  name TEXT NOT NULL,
  version INT NOT NULL,
  PRIMARY KEY (name)
) TABLESPACE pg_default;

-- create db_upgrade_log table
CREATE TABLE db_upgrade_log (
  id SERIAL,
  version INT NOT NULL,
  status TEXT NOT NULL,
  script TEXT,
  returncode INT,
  stdout TEXT,
  stderr TEXT,
  last_updated TIMESTAMP WITH TIME ZONE NOT NULL
) TABLESPACE pg_default;

CREATE INDEX ON db_upgrade_log(version);

CREATE TRIGGER db_upgrade_log_set_last_updated
  BEFORE INSERT OR UPDATE ON db_upgrade_log
  FOR EACH ROW EXECUTE PROCEDURE set_last_updated();


-- user for evaluator component
GRANT SELECT ON db_version TO ve_db_user_evaluator;
GRANT SELECT ON db_upgrade_log TO ve_db_user_evaluator;
GRANT USAGE, SELECT ON db_upgrade_log_id_seq TO ve_db_user_evaluator;

-- user for listener component
GRANT SELECT ON db_version TO ve_db_user_listener;
GRANT SELECT ON db_upgrade_log TO ve_db_user_listener;
GRANT USAGE, SELECT ON db_upgrade_log_id_seq TO ve_db_user_listener;

-- user for UI manager component
GRANT SELECT ON db_version TO ve_db_user_manager;
GRANT SELECT ON db_upgrade_log TO ve_db_user_manager;

