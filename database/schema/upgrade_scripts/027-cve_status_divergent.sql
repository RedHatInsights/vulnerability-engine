ALTER TABLE cve_account_data ADD COLUMN systems_status_divergent INT NOT NULL DEFAULT 0;

-- migrate existing divergent status counts
update cve_account_data
set systems_status_divergent = t2.systems_status_divergent
from (
    select t1.rh_account_id, t1.cve_id, count(distinct sv.id) as systems_status_divergent
    from (select rh_account_id, cve_id, status_id from cve_account_data) t1
    join system_platform sp on (sp.rh_account_id = t1.rh_account_id)
    join system_vulnerabilities sv on (sv.cve_id = t1.cve_id and sv.system_id = sp.id)
    where sv.status_id != t1.status_id
    and sp.opt_out is false
    and sv.when_mitigated is null
    group by t1.rh_account_id, t1.cve_id
) t2
where cve_account_data.cve_id = t2.cve_id
and cve_account_data.rh_account_id = t2.rh_account_id;
