-- Support for independent counting of satellite managed systems

DO $$
BEGIN
    ALTER TABLE cve_affected_systems_cache ADD direct_systems_affected INT NOT NULL DEFAULT 0;
EXCEPTION   
    WHEN duplicate_column THEN
        RAISE NOTICE 'Column direct_systems_affected already exists.';
END$$;

CREATE OR REPLACE FUNCTION refresh_all_cached_counts()
  RETURNS void AS
$refresh_all_cached_counts$
  BEGIN
    UPDATE system_platform sp SET cve_count_cache = (
      SELECT COUNT(cve) FROM system_vulnerabilities sv
      WHERE sv.inventory_id = sp.inventory_id AND sv.when_mitigated IS NULL
    );
    DELETE FROM cve_affected_systems_cache;
    INSERT INTO cve_affected_systems_cache (cve, rh_account, systems_affected, direct_systems_affected)
      SELECT sv.cve, sp.rh_account, count(sv.inventory_id), count(CASE WHEN sp.satellite_managed THEN NULL ELSE 1 END)
      FROM system_vulnerabilities sv INNER JOIN
           system_platform sp USING (inventory_id)
      WHERE sp.last_evaluation IS NOT NULL AND
            sp.opt_out = FALSE AND
            sv.when_mitigated IS NULL
      GROUP BY sv.cve, sp.rh_account;
  END;
$refresh_all_cached_counts$
  LANGUAGE 'plpgsql';

-- opt_out_system_update_cache
CREATE OR REPLACE FUNCTION opt_out_system_update_cache()
  RETURNS TRIGGER AS
$opt_out_system_update_cache$
  BEGIN
    IF (TG_OP = 'UPDATE') AND NEW.last_evaluation IS NOT NULL THEN
      -- system opted out
      IF OLD.opt_out = FALSE AND NEW.opt_out = TRUE THEN
        -- decrement affected cve counts for system
        WITH to_update_cves AS (
          SELECT casc.cve
          FROM cve_affected_systems_cache casc INNER JOIN
               system_vulnerabilities sv ON casc.cve = sv.cve
          WHERE casc.rh_account = NEW.rh_account AND
                sv.inventory_id = NEW.inventory_id AND
                sv.when_mitigated IS NULL
          FOR UPDATE OF casc
        )
        UPDATE cve_affected_systems_cache casc
        SET systems_affected = systems_affected - 1,
            direct_systems_affected = CASE WHEN NEW.satellite_managed THEN direct_systems_affected ELSE direct_systems_affected - 1 END
        FROM to_update_cves
        WHERE casc.cve = to_update_cves.cve AND
              casc.rh_account = NEW.rh_account;
        -- delete zero cve counts
        DELETE FROM cve_affected_systems_cache
        WHERE rh_account = NEW.rh_account AND
              systems_affected = 0;

      -- system opted in
      ELSIF OLD.opt_out = TRUE AND NEW.opt_out = FALSE THEN
        -- increment affected cve counts for system
        WITH to_update_cves AS (
          SELECT casc.cve
          FROM cve_affected_systems_cache casc INNER JOIN
               system_vulnerabilities sv ON casc.cve = sv.cve
          WHERE casc.rh_account = NEW.rh_account AND
                sv.inventory_id = NEW.inventory_id AND
                sv.when_mitigated IS NULL
          FOR UPDATE OF casc
        )
        UPDATE cve_affected_systems_cache casc
        SET systems_affected = systems_affected + 1,
            direct_systems_affected = CASE when NEW.satellite_managed THEN direct_systems_affected ELSE direct_systems_affected + 1 END
        FROM to_update_cves
        WHERE casc.cve = to_update_cves.cve AND
              casc.rh_account = NEW.rh_account;
        -- insert cache if not exists
        INSERT INTO cve_affected_systems_cache (cve, rh_account, systems_affected, direct_systems_affected)
        SELECT sv.cve, NEW.rh_account, 1, CASE WHEN NEW.satellite_managed THEN 0 ELSE 1 END
        FROM system_vulnerabilities sv
        WHERE sv.inventory_id = NEW.inventory_id AND
              sv.when_mitigated IS NULL AND
              NOT EXISTS (
                SELECT 1 FROM cve_affected_systems_cache
                WHERE rh_account = NEW.rh_account AND
                      cve = sv.cve
              );
      END IF;
    END IF;
    RETURN NEW;
  END;
$opt_out_system_update_cache$
  LANGUAGE 'plpgsql';

-- satellite_managed_system_update_cache
CREATE OR REPLACE FUNCTION satellite_managed_system_update_cache()
  RETURNS TRIGGER AS
$satellite_managed_system_update_cache$
  BEGIN
    IF (TG_OP = 'UPDATE') AND NEW.last_evaluation IS NOT NULL THEN
      -- system started to be managed by satellite
      IF OLD.satellite_managed = FALSE AND NEW.satellite_managed = TRUE THEN
        -- decrement affected cve counts for satellite managed system
        WITH to_update_cves AS (
          SELECT casc.cve
          FROM cve_affected_systems_cache casc INNER JOIN
               system_vulnerabilities sv ON casc.cve = sv.cve
          WHERE casc.rh_account = NEW.rh_account AND
                sv.inventory_id = NEW.inventory_id AND
                sv.when_mitigated IS NULL
          FOR UPDATE OF casc
        )
        UPDATE cve_affected_systems_cache casc
        SET direct_systems_affected = direct_systems_affected - 1
        FROM to_update_cves
        WHERE casc.cve = to_update_cves.cve AND
              casc.rh_account = NEW.rh_account;

      -- system stopped to managed by satellite
      ELSIF OLD.satellite_managed = TRUE AND NEW.satellite_managed = FALSE THEN
        -- increment affected cve counts for system
        WITH to_update_cves AS (
          SELECT casc.cve
          FROM cve_affected_systems_cache casc INNER JOIN
               system_vulnerabilities sv ON casc.cve = sv.cve
          WHERE casc.rh_account = NEW.rh_account AND
                sv.inventory_id = NEW.inventory_id AND
                sv.when_mitigated IS NULL
          FOR UPDATE OF casc
        )
        UPDATE cve_affected_systems_cache casc
        SET direct_systems_affected = direct_systems_affected + 1
        FROM to_update_cves
        WHERE casc.cve = to_update_cves.cve AND
              casc.rh_account = NEW.rh_account;
      END IF;
    END IF;
    RETURN NEW;
  END;
$satellite_managed_system_update_cache$
  LANGUAGE 'plpgsql';

DO $$
BEGIN
  CREATE TRIGGER system_platform_satellite_managed_cache
    AFTER UPDATE OF satellite_managed ON system_platform
    FOR EACH ROW EXECUTE PROCEDURE satellite_managed_system_update_cache();  
EXCEPTION   
  WHEN others THEN
    RAISE NOTICE 'Trigger system_platform_satellite_managed_cache already exists.';
END$$;

-- listner user needs to update direcly attached systems
GRANT UPDATE (direct_systems_affected) ON cve_affected_systems_cache TO ve_db_user_listener;

-- refresh cached counts in order to populate direct_systems_affected
SELECT refresh_all_cached_counts();