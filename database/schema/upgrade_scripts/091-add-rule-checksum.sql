ALTER TABLE system_platform ADD COLUMN advisor_checksum TEXT;
ALTER TABLE system_platform ADD COLUMN advisor_unchanged_since TIMESTAMP WITH TIME ZONE NOT NULL default CURRENT_TIMESTAMP;
ALTER TABLE system_platform ALTER COLUMN advisor_unchanged_since DROP DEFAULT;

create or replace function check_unchanged()
  RETURNS TRIGGER AS
$check_unchanged$
  BEGIN
    IF (TG_OP = 'INSERT') THEN
      IF (NEW.unchanged_since IS NULL) THEN
        NEW.unchanged_since := CURRENT_TIMESTAMP;
      END IF;
      IF (NEW.advisor_unchanged_since IS NULL) THEN
        NEW.advisor_unchanged_since := CURRENT_TIMESTAMP;
      END IF;
    END IF;
    IF (TG_OP = 'UPDATE') THEN
      IF (NEW.json_checksum <> OLD.json_checksum) THEN
        NEW.unchanged_since := CURRENT_TIMESTAMP;
      END IF;
      IF (NEW.advisor_checksum <> OLD.advisor_checksum) THEN
        NEW.advisor_unchanged_since := CURRENT_TIMESTAMP;
      END IF;
    END IF;
    RETURN NEW;
  END;
$check_unchanged$
  LANGUAGE 'plpgsql';
