"""
Module for /error_keys API endpoint
"""

import json

from common import AuthenticatedHandler, parse_url
from database.peewee_model import SysVulnRulesResults, SystemVulnerabilities, ProdsecErrorKey, SystemPlatform


class ErrorKeyHandler(AuthenticatedHandler):
    """Handler class returning data related to given error key."""

    def get(self): # pylint: disable=arguments-differ, useless-super-delegation
        """
        ---
        description: Get error key details
        responses:
          200:
            description: Error key details returned.
        """
        super(ErrorKeyHandler, self).get()

    def handle_get(self):
        route = parse_url(self.request.uri, "/error_keys")
        if len(route) == 2 and route[1] == "affected_systems":
            self.get_affected_systems(route[0])
        else:
            self.raiseError(404)
        self.flush()

    def post(self): # pylint: disable=arguments-differ
        self.flush()

    def get_affected_systems(self, error_key):
        """Gets affected systems with same error key"""
        query = (
            SysVulnRulesResults
            .select(SystemPlatform.insights_id,
                    SystemPlatform.inventory_id,
                    SystemPlatform.display_name,
                    ProdsecErrorKey.name.alias("error_key"))
            .join(SystemVulnerabilities, on=(SysVulnRulesResults.sys_vuln_id == SystemVulnerabilities.id))
            .join(SystemPlatform, on=(SystemVulnerabilities.insights_id == SystemPlatform.insights_id))
            .join(ProdsecErrorKey, on=(SysVulnRulesResults.error_key_id == ProdsecErrorKey.id))
            .where(ProdsecErrorKey.name == error_key)
            .where(SystemPlatform.rh_account == self.rh_account_number)
            .dicts()
        )
        affected_systems = []
        for row in query:
            system_entry = {}
            system_entry["insights_id"] = row["insights_id"]
            system_entry["inventory_id"] = row["inventory_id"]
            system_entry["display_name"] = row["display_name"]
            system_entry["error_key"] = row["error_key"]
            affected_systems.append(system_entry)
        self.write(json.dumps(affected_systems))
