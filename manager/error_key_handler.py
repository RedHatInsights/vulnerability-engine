import json

from common import AuthenticatedHandler, parse_url, vmaas_call
from database.database_handler import DatabaseHandler


class ErrorKeyHandler(AuthenticatedHandler):
    """Handler class returning data related to given error key."""

    def get(self):
        """
        ---
        description: Get error key details
        responses:
          200:
            description: Error key details returned.
        """
        route = parse_url(self.request.uri, "/errorkeys")
        if len(route) == 2 and route[1] == "affectedsystems":
            self.get_affected_systems(route[0])
        else:
            self.send_error(404)
        self.flush()

    def post(self):
        self.flush()

    def get_affected_systems(self, error_key):
        self.conn = DatabaseHandler.get_connection()
        cur = self.conn.cursor()
        print(error_key)
        cur.execute(
            "SELECT s.platform_id, s.display_name, ek.name \
            FROM system_prodsec_error_key sek \
            JOIN system_platform s ON sek.platform_id = s.platform_id \
            JOIN prodsec_error_key ek ON sek.error_key_id = ek.id \
            WHERE ek.name = %s AND s.rh_account = %s", (error_key, self.rh_account_number))
        affected_systems = []
        for system in cur.fetchall():
            system_entry = {}
            system_entry["platform_id"] = system[0]
            system_entry["display_name"] = system[1]
            system_entry["error_key"] = system[2]
            affected_systems.append(system_entry)
        self.write(json.dumps(affected_systems))
