"""
Module for /feature API endpoint
"""
from connexion import context

from common.peewee_model import NotifiedAccounts
from common.peewee_model import RHAccount
from manager.base import ApplicationException
from manager.base import DeleteRequest
from manager.base import get_account_data
from manager.base import PatchRequest
from manager.rbac_manager import RbacManager as RBAC
from manager.rbac_manager import RbacRoutePermissions


class PatchCvesWithoutErrata(PatchRequest):
    """PATCH to /feature/cves_without_errata"""

    _endpoint_name = r"/v1/feature/cves_without_errata"

    @classmethod
    @RBAC.need_permissions(RbacRoutePermissions.TOGGLE_CVES_WITHOUT_ERRATA)
    def handle_patch(cls, **kwargs):
        """Set cves_without_errata DB flag for account."""
        org_id = context.context["user"]["org_id"]
        enable = kwargs["body"]["enable"]
        RHAccount.update(cves_without_errata=enable).where(RHAccount.org_id == org_id).execute()
        return {"updated": {"org_id": org_id, "cves_without_errata": {"enabled": enable}}}


class DeleteNotifications(DeleteRequest):
    """DELETE to /notifications"""

    _endpoint_name = r"/v1/notifications"

    @classmethod
    def handle_delete(cls, **kwargs):
        """Deletes customer sent notifications"""
        rh_account_id = get_account_data(context.context["user"]).id
        if rh_account_id is None:
            raise ApplicationException("user does not exist", 403)

        deleted_cnt = NotifiedAccounts.delete().where(NotifiedAccounts.rh_account_id == rh_account_id).execute()
        return {"deleted": deleted_cnt}
