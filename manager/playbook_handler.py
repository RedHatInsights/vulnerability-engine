"""
Module for /playbook APIs
"""
from peewee import DoesNotExist

from common.peewee_model import InsightsRule, Playbook
from .base import GetRequest
from .rbac_manager import RbacRoutePermissions, RbacManager as RBAC


class GetTemplate(GetRequest):
    """GET to /playbooks/templates/{rule_id}"""

    _endpoint_name = r'/playbooks/templates/{rule_id}'

    @classmethod
    @RBAC.need_permissions(RbacRoutePermissions.REMEDIATIONS_READ)
    def handle_get(cls, **kwargs):
        try:
            rule_id = InsightsRule.select(InsightsRule.id).where(InsightsRule.name == kwargs['rule_id']).get()
        except DoesNotExist:
            return cls.format_exception('Rule %s does not exist' % kwargs['rule_id'], 404)
        data = Playbook.select(
            Playbook.description,
            Playbook.play,
            Playbook.version).where(Playbook.rule_id == rule_id).dicts()
        return {'data': [playbook for playbook in data]}  # pylint: disable=bad-option-value,unnecessary-comprehension
