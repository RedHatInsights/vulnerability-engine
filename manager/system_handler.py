import json

from common import AuthenticatedHandler, parse_url, InvalidArgumentException
from database.peewee_model import CveMetadata, SystemPlatform, SystemVulnerabilities
from list_view import ListView

class SystemCvesView(ListView):
    def __init__(self, list_args, query_args):
        query = (
            SystemVulnerabilities
            .select(CveMetadata.cve.alias('cve_name'),
                    CveMetadata.cvss3_score,
                    CveMetadata.impact,
                    CveMetadata.public_date,
                    CveMetadata.description.alias('cve_description'))
            .join(SystemPlatform, on=(SystemVulnerabilities.platform_id == SystemPlatform.platform_id))
            .join(CveMetadata, on=(SystemVulnerabilities.cve == CveMetadata.cve))
            .where(SystemPlatform.rh_account == query_args['rh_account_number'])
            .where(SystemPlatform.platform_id == query_args['platform_id'])
            .dicts()
        )
        sortable_columns = {
            'cve' : SystemVulnerabilities.cve,
            'public_date' : CveMetadata.public_date,
            'cvss_score' : CveMetadata.cvss3_score,
            'impact' : CveMetadata.impact
        }
        filterable_columns = {
            'cve' : SystemVulnerabilities.cve,
            'description' : CveMetadata.description
        }
        super(SystemCvesView, self).__init__(query, sortable_columns, filterable_columns, list_args)

class SystemHandler(AuthenticatedHandler):

    def get(self):
        """Get CVEs for a system
           ---
           description: Get CVEs for a system
           responses:
             200:
               description: JSON containing CVEs for a systems is returuned
        """
        route = parse_url(self.request.uri, "/systems")
        if len(route) == 2 and route[1] == 'cves':
            self.get_cves(route[0])
        else:
            self.raiseError(404)
        self.flush()

    def post(self):
        self.flush()

    def get_cves(self, platform_id):
        try:
            cves_view = SystemCvesView(self._parse_list_arguments(), {"rh_account_number": self.rh_account_number, 'platform_id' : platform_id})
        except InvalidArgumentException as e:
            self.raiseError(400, str(e))
            return
        response = {}
        result = []
        for cve in cves_view:
            record = {}
            record['synopsis'] = cve['cve_name']
            record['public_date'] = cve['public_date'].isoformat()
            record['impact'] = cve['impact']
            record['description'] = cve['cve_description']
            record['cvss_score'] = str(cve['cvss3_score']) if cve['cvss3_score'] else ''
            result.append({'type' : 'cve', 'id' : cve['cve_name'], 'attributes' : record})
        try:
            response['meta'] = cves_view.get_metadata()
            response['data'] = result
        except Exception as e:
            self.raiseError(500, str(e))
            return
        self.write(json.dumps(response))
