#!/usr/bin/python3

import os
import sys

from common import DEFAULT_ROUTE
from cve_handler import CVEHandler
from database.database_handler import init_db
from tornado import httpserver, ioloop, web
from vulnerabilities_handler import VulnerabilitiesHandler


class ServerApplication():

    def __init__(self):
        handlers = [
            (DEFAULT_ROUTE + r"/cves/CVE-[^/]*/?[^/]*/?$", CVEHandler),
            (DEFAULT_ROUTE + r"/vulnerabilities/.*", VulnerabilitiesHandler)
        ]
        application = web.Application(handlers)
        http_server = httpserver.HTTPServer(application, ssl_options={
            "certfile": os.path.join(sys.path[0], "localhost.crt"),
            "keyfile": os.path.join(sys.path[0], "localhost.key")
        })
        http_server.listen(8443)
        self.instance = ioloop.IOLoop.instance()

    def start(self):
        self.instance.start()


def main():
    init_db()
    app = ServerApplication()
    app.start()


if __name__ == '__main__':
    main()
