"""
Module for /cves API endpoint
"""

import connexion
from peewee import DoesNotExist

from common.peewee_model import SystemVulnerabilities, SystemPlatform, CveMetadata, Status
from .base import ApplicationException, GetRequest, parse_int_list
from .list_view import ListView


class AffectedSystemsView(ListView):
    """Database select for /cves API endpoint"""

    def __init__(self, synopsis, list_args, query_args, filter_args, parsed_args, uri):

        query = (
            SystemVulnerabilities
            .select(SystemPlatform.inventory_id,
                    SystemPlatform.satellite_managed,
                    SystemPlatform.last_evaluation,
                    Status.id.alias('status_id'),
                    Status.name.alias('status_name'))
            .join(SystemPlatform, on=(SystemVulnerabilities.inventory_id == SystemPlatform.inventory_id))
            .join(Status, on=(SystemVulnerabilities.status_id == Status.id))
            .join(CveMetadata, on=(SystemVulnerabilities.cve == CveMetadata.cve))
            .where(CveMetadata.cve == synopsis)
            .where(SystemPlatform.rh_account == query_args['rh_account_number'])
            .where(SystemVulnerabilities.when_mitigated.is_null(True))
            .where(SystemPlatform.opt_out == False)  # pylint: disable=singleton-comparison
        )

        if query_args['hide_satellite_managed']:
            query = query.where(SystemPlatform.satellite_managed == False)  # pylint: disable=singleton-comparison
        if 'status_id' in filter_args and filter_args['status_id']:
            query = query.where(Status.id << filter_args['status_id'])

        query = query.dicts()

        filterable_columns = {
            'inventory_id': SystemPlatform.inventory_id
        }
        super(AffectedSystemsView, self).__init__(query, None, filterable_columns, list_args, parsed_args, uri)


class Cves(GetRequest):
    """we have two endpoints which do the same thing, merge them"""

    @classmethod
    def _cve_details(cls, synopsis):
        data = cls.vmaas_call("/api/v1/cves/", {"cve_list": [synopsis]})
        cve_list = data["cve_list"]
        if synopsis not in cve_list:
            raise ApplicationException('No such CVE ID', 404)
        return cve_list[synopsis]

    @classmethod
    def handle_get(cls, **kwargs):
        res = {}
        res['data'] = {'attributes': cls._cve_details(kwargs['cve_id']), 'id': kwargs['cve_id'], 'type': 'cve'}
        return res


class GetCves(Cves):
    """GET to /v1/cves/{cve_id}"""

    _endpoint_name = r'/v1/cves/{cve_id}'


class GetCvesDetails(Cves):
    """GET to /v1/cves/{cve_id}/details"""

    _endpoint_name = r'/v1/cves/{cve_id}/details'


class GetCvesAffectedSystems(GetRequest):
    """GET to /v1/cves/{cve_id}/affected_systems"""

    _endpoint_name = r'/v1/cves/{cve_id}/affected_systems'

    @staticmethod
    def _cve_exists(synopsis):
        try:
            (CveMetadata.select(CveMetadata.cve)
             .where(CveMetadata.cve == synopsis)
             .get())
        except DoesNotExist:
            raise ApplicationException('No such CVE ID', 404)

    @classmethod
    def handle_get(cls, **kwargs):
        """Gets systems affected by a CVE"""
        synopsis = kwargs['cve_id']
        cls._cve_exists(synopsis)
        args_desc = [{'arg_name': 'status_id', 'convert_func': parse_int_list}]
        args = cls._parse_arguments(kwargs, args_desc)
        list_arguments = cls._parse_list_arguments(kwargs)
        asys_view = AffectedSystemsView(synopsis,
                                        list_arguments, {"rh_account_number": connexion.context['user'],
                                                         'hide_satellite_managed': cls.hide_satellite_managed()},
                                        args, args, connexion.request.path)

        response = {}
        result = []
        for sys in asys_view:
            record = {}
            # TODO:
            # result prob can be just {'type':'system', 'id':<inventory_id>}
            record['inventory_id'] = sys['inventory_id']
            record['status_id'] = sys['status_id']
            record['status_name'] = sys['status_name']
            record['satellite_managed'] = sys['satellite_managed']
            record['last_evaluation'] = sys['last_evaluation'].isoformat() if sys['last_evaluation'] else ''
            result.append({'type': 'system', 'id': sys['inventory_id'], 'attributes': record})
        response['meta'] = asys_view.get_metadata()
        response['links'] = asys_view.get_pagination_links()
        response['data'] = cls._format_data(list_arguments["data_format"], result)
        return response
