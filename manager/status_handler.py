"""
Module for /status API endpoint
"""

import json
import logging

from peewee import DoesNotExist, IntegrityError

from common import AuthenticatedHandler
from database.peewee_handler import PeeweeHandler
from database.peewee_model import SystemPlatform, SystemVulnerabilities, Status

class StatusHandler(AuthenticatedHandler):
    """Handler for /status endpoint"""

    def get(self): # pylint: disable=arguments-differ, useless-super-delegation
        """GET to return the list of available status_id/status pairs
           ---
           description: GET to return the list of available status_id/status pairs
           responses:
             200:
               description: status-list returned
               schema:
                 $ref: '#/definitions/StatusList'
           tags:
            - status
        """
        super(StatusHandler, self).get()

    def post(self): # pylint: disable=arguments-differ, useless-super-delegation
        """
           ---
           description: POST to set the status-id for a specified insights-id/cve combination
           parameters:
             - name: body
               description: Input JSON
               required: True
               in: body
               schema:
                 type: object
                 properties:
                   insights_id:
                     type: string
                   cve:
                     type: string
                     example: CVE-2019-000666
                   status_id:
                     type: int
                     example: 3
                 required:
                   - insights_id
                   - cve
                   - status_id
           responses:
             200:
               description: status successfully changed
             400:
               description: malformed JSON, missing one of insights_id/cve/status_id, or bad status_id
             404:
               description: specified insights_id/cve does not exist or is not visible to requesting rh_account_num
           tags:
            - status
        """
        super(StatusHandler, self).post()

    def handle_post(self):
        """Update the 'status' field for a system/cve combination"""
        data = self.get_post_data()
        if not data or not ('insights_id' in data and 'cve' in data and 'status_id' in data):
            # data must exist, be valid JSON, and sysid/cve/status_id must ALL be provided
            self.raiseError(400, 'data must exist, be valid JSON, and sysid/cve/status_id must ALL be provided')
            return

        in_insights_id = data['insights_id']
        in_cve = data['cve']
        in_status_id = data['status_id']
        logging.debug('SYSID [%s] CVE [%s] STATUS-ID [%s] ACCT [%s]',
                      in_insights_id, in_cve, in_status_id, self.rh_account_number)
        try:
            vuln = (SystemVulnerabilities.select()
                    .join(SystemPlatform)
                    .where((SystemVulnerabilities.insights_id == in_insights_id) &
                           (SystemVulnerabilities.cve == in_cve) &
                           (SystemPlatform.rh_account == self.rh_account_number))
                    .get())
            vuln.status_id = in_status_id
            vuln.save()
            self.flush()
        except DoesNotExist:
            # sysid/cve/acct combination does not exist
            self.raiseError(404, 'insights-id/cve must exist and insights-id must be visible to user')
        except IntegrityError as integ_error:
            # usually means bad-status-id
            PeeweeHandler.rollback()
            self.raiseError(400, str(integ_error))

    def handle_get(self):
        """Return the data from the Status table as JSON"""
        query = (Status.select().order_by(Status.id.asc()).dicts())
        status_list = []
        for status in query:
            status_list.append(status)
        logging.debug(status_list)
        self.write(json.dumps(status_list))
        self.flush()
