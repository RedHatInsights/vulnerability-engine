"""
Module for /dashboard API
"""
from datetime import datetime, timedelta, timezone

import connexion
from peewee import fn, JOIN, SQL

from common.logging import get_logger
from common.peewee_model import CveMetadata, CveRuleMapping, InsightsRule, SystemVulnerabilities, SystemPlatform
from .base import cyndi_query, get_account_id, GetRequest, get_system_count, parse_tags, round_to_100_percent, \
                  is_cyndi_request
from .filters import apply_filters, filter_types

LOGGER = get_logger(__name__)


class GetDashboard(GetRequest):
    """Get to /v1/dashboard"""

    _endpoint_name = r'/v1/dashboard'

    @classmethod
    def handle_get(cls, **kwargs):
        # pylint: disable=singleton-comparison, too-many-branches
        retval = {
            'cves_total': 0,
            'cves_by_severity': {
                '0to3.9': {
                    'percentage': 0,
                    'count': 0
                },
                '4to7.9': {
                    'percentage': 0,
                    'count': 0
                },
                '8to10': {
                    'percentage': 0,
                    'count': 0
                },
                'na': {
                    'percentage': 0,
                    'count': 0
                }
            },
            'system_count': 0,
            'recent_cves': {
                'last7days': 0,
                'last30days': 0,
                'last90days': 0
            },
            'recent_rules': [],
            'rules_total': 0,
        }

        args_desc = [
            {'arg_name': 'tags', 'convert_func': parse_tags},
            {'arg_name': 'sap_system', 'convert_func': None},
            {'arg_name': 'sap_sids', 'convert_func': None}
        ]
        args = cls._parse_arguments(kwargs, args_desc)
        cyndi_request = is_cyndi_request(args)
        rh_account = get_account_id(connexion.context['user'])
        retval['system_count'] = get_system_count(rh_account, True, [filter_types.SYSTEM_TAGS, filter_types.SYSTEM_SAP, filter_types.SYSTEM_SAP_SIDS], args)

        system_exists_subquery = (SystemPlatform
                                  .select(SystemPlatform.id)
                                  .where(SystemPlatform.rh_account_id == rh_account)
                                  .where(SystemPlatform.stale == False)  # noqa: E712
                                  .where(SystemPlatform.opt_out == False)  # noqa: E712
                                  .where(SystemPlatform.when_deleted.is_null(True))
                                  .where(SystemPlatform.last_evaluation.is_null(False) | SystemPlatform.advisor_evaluated.is_null(False))
                                  .where(SystemPlatform.id == SystemVulnerabilities.system_id))
        if cyndi_request:
            system_exists_subquery = cyndi_query(system_exists_subquery)
            system_exists_subquery = apply_filters(system_exists_subquery, args,
                                                   [filter_types.SYSTEM_TAGS, filter_types.SYSTEM_SAP, filter_types.SYSTEM_SAP_SIDS], {})

        query = (SystemVulnerabilities.select(fn.Distinct(CveMetadata.cve), fn.COALESCE(CveMetadata.cvss3_score, CveMetadata.cvss2_score).alias('cvss_score'),
                                              CveMetadata.public_date, CveMetadata.id)
                 .join(CveMetadata, on=(SystemVulnerabilities.cve_id == CveMetadata.id))
                 .where(SystemVulnerabilities.rh_account_id == rh_account)
                 .where((SystemVulnerabilities.mitigation_reason.is_null(True)) |
                        (SystemVulnerabilities.rule_id << InsightsRule.select(InsightsRule.id).where(InsightsRule.active == False)))  # noqa: E712
                 .where((SystemVulnerabilities.when_mitigated.is_null(True)) |
                        (SystemVulnerabilities.rule_id << InsightsRule.select(InsightsRule.id).where(InsightsRule.active == True)))
                 .where(fn.Exists(system_exists_subquery))
                 .dicts())

        cve_data = [(cve["cvss_score"], cve["public_date"]) for cve in query]

        retval["cves_total"] = len(cve_data)

        today = datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)  # offset-aware
        last7 = today - timedelta(days=7)
        last14 = today - timedelta(days=14)
        last30 = today - timedelta(days=30)
        last90 = today - timedelta(days=90)

        for cvss_score, public_date in cve_data:
            if cvss_score is None:
                retval["cves_by_severity"]["na"]["count"] += 1
            elif cvss_score < 4:
                retval["cves_by_severity"]["0to3.9"]["count"] += 1
            elif 4 <= cvss_score < 8:
                retval["cves_by_severity"]["4to7.9"]["count"] += 1
            elif cvss_score >= 8:
                retval["cves_by_severity"]["8to10"]["count"] += 1

            if public_date >= last7:
                retval["recent_cves"]["last7days"] += 1
            if public_date >= last30:
                retval["recent_cves"]["last30days"] += 1
            if public_date >= last90:
                retval["recent_cves"]["last90days"] += 1

        rounded_percentage = round_to_100_percent([v['count'] for v in retval['cves_by_severity'].values()])

        for indx, keys in enumerate(retval['cves_by_severity']):
            retval['cves_by_severity'][keys]['percentage'] = rounded_percentage[indx]

        rules_breakdown = (SystemVulnerabilities.select(fn.COUNT(fn.Distinct(InsightsRule.id)).alias('rule_count'))
                           .join(InsightsRule, on=(SystemVulnerabilities.rule_id == InsightsRule.id))  # noqa: E712
                           .join(SystemPlatform, on=((SystemVulnerabilities.system_id == SystemPlatform.id) & (SystemPlatform.rh_account_id == rh_account) &
                                                     (SystemPlatform.when_deleted.is_null(True)) &
                                                     (SystemPlatform.stale == False) & (SystemPlatform.opt_out == False) &  # noqa: E712
                                                     (SystemPlatform.last_evaluation.is_null(False) | SystemPlatform.advisor_evaluated.is_null(False))))
                           .where(SystemVulnerabilities.rh_account_id == rh_account)
                           .where((SystemVulnerabilities.rule_id << InsightsRule.select(InsightsRule.id).where(InsightsRule.active == True)) &
                                  (SystemVulnerabilities.mitigation_reason.is_null(True))))
        if cyndi_request:
            rules_breakdown = cyndi_query(rules_breakdown)
            rules_breakdown = apply_filters(rules_breakdown, args, [filter_types.SYSTEM_TAGS, filter_types.SYSTEM_SAP, filter_types.SYSTEM_SAP_SIDS], {})
        rules_breakdown = rules_breakdown.first()

        retval['rules_total'] = rules_breakdown.rule_count

        counts_query = (
            SystemVulnerabilities
            .select(SystemVulnerabilities.rule_id.alias("rule_id_"),
                    fn.Count(fn.Distinct(SystemVulnerabilities.system_id)).alias("systems_affected_"))
            .join(SystemPlatform, on=((SystemVulnerabilities.system_id == SystemPlatform.id) &
                                      (SystemPlatform.rh_account_id == rh_account) &
                                      (SystemPlatform.opt_out == False) &  # noqa: E712
                                      (SystemPlatform.stale == False) &  # noqa: E712
                                      (SystemPlatform.when_deleted.is_null(True))))
            .where(SystemVulnerabilities.rh_account_id == rh_account)
            .where((SystemVulnerabilities.rule_id << InsightsRule.select(InsightsRule.id).where(InsightsRule.active == True)) &
                   (SystemVulnerabilities.mitigation_reason.is_null(True)))
            .group_by(SystemVulnerabilities.rule_id)
        )
        if cyndi_request:
            counts_query = cyndi_query(counts_query)
            counts_query = apply_filters(counts_query, args, [filter_types.SYSTEM_TAGS, filter_types.SYSTEM_SAP, filter_types.SYSTEM_SAP_SIDS], {})

        recent_rules = (InsightsRule.select(InsightsRule.description_text.alias('name'),
                                            InsightsRule.summary_text.alias('description'),
                                            fn.COALESCE(counts_query.c.systems_affected_, 0).alias('systems_affected'),
                                            InsightsRule.rule_impact.alias('severity'),
                                            InsightsRule.kbase_node_id.alias('node_id'),
                                            fn.ARRAY_AGG(fn.Distinct(CveMetadata.cve)).alias('associated_cves'),
                                            InsightsRule.name.alias('id'),
                                            InsightsRule.publish_date.alias('public_date'))
                        .join(CveRuleMapping, on=(InsightsRule.id == CveRuleMapping.rule_id))
                        .join(counts_query, JOIN.LEFT_OUTER, on=(InsightsRule.id == counts_query.c.rule_id_))
                        .join(CveMetadata, on=(CveRuleMapping.cve_id == CveMetadata.id))
                        .where((InsightsRule.publish_date >= last14) & (InsightsRule.active == True))  # noqa: E712
                        .group_by(InsightsRule.description_text, InsightsRule.publish_date, InsightsRule.rule_impact, InsightsRule.kbase_node_id,
                                  SQL('systems_affected'), InsightsRule.name, InsightsRule.publish_date, InsightsRule.summary_text)
                        .order_by(InsightsRule.publish_date.desc(), InsightsRule.rule_impact, InsightsRule.description_text)
                        .dicts())

        recent_rules = apply_filters(recent_rules, args, [], {"count_subquery": counts_query})

        for rule in recent_rules:
            retval['recent_rules'].append(rule)

        return retval
