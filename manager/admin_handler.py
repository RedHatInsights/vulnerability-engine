"""
Module for /refresh API endpoints
"""

from common.logging import get_logger
from common.peewee_model import DB, SystemPlatform, CveMetadata, RHAccount
from .base import DeleteRequest, GetRequest, PutRequest, ApplicationException

LOGGER = get_logger(__name__)


class Refresh(PutRequest):
    """Meta class for refresh APIs"""

    @classmethod
    def _account_exists(cls, account):
        if account is None:
            raise ApplicationException("invalid account_id", 400)
        systems = (SystemPlatform.select()
                   .join(RHAccount, on=(SystemPlatform.rh_account_id == RHAccount.id))
                   .where(RHAccount.name == account))
        if not systems.exists():
            raise ApplicationException("account_id must exist", 404)

    @classmethod
    def _cve_exists(cls, cve):
        if cve is None:
            raise ApplicationException("invalid cve_id", 400)
        cve = (CveMetadata.select()
               .where(CveMetadata.cve == cve))
        if not cve.exists():
            raise ApplicationException("cve_id must exist", 404)

    @classmethod
    def _system_exists(cls, inventory_id):
        if inventory_id is None:
            raise ApplicationException("invalid inventory_id", 400)
        system = (SystemPlatform.select()
                  .where(SystemPlatform.inventory_id == inventory_id))
        if not system.exists():
            raise ApplicationException("inventory_id must exist", 404)

    @classmethod
    def handle_put(cls, **kwargs):  # pragma: no cover
        """To be implemented in child classes"""
        raise NotImplementedError


class RefreshAccount(Refresh):
    """PUT to /v1/refresh/accounts/{account_id}"""

    _endpoint_name = r'/v1/refresh/accounts/{account_id}'

    @classmethod
    def handle_put(cls, **kwargs):
        """Refresh cached counts for given account ID."""
        account = kwargs.get("account_id", None)
        cls._account_exists(account)
        DB.execute_sql("SELECT refresh_account_cached_counts(%s)", (account,))
        return ""


class RefreshAccountCve(Refresh):
    """PUT to /v1/refresh/accounts/{account_id}/cves/{cve_id}"""

    _endpoint_name = r'/v1/refresh/accounts/{account_id}/cves/{cve_id}'

    @classmethod
    def handle_put(cls, **kwargs):
        """Refresh cached counts for given account ID and CVE."""
        account = kwargs.get("account_id", None)
        cve = kwargs.get("cve_id", None)
        cls._account_exists(account)
        cls._cve_exists(cve)
        DB.execute_sql("SELECT refresh_cve_account_cached_counts(%s, %s)", (cve, account))
        return ""


class RefreshCve(Refresh):
    """PUT to /v1/refresh/cves/{cve_id}"""

    _endpoint_name = r'/v1/refresh/cves/{cve_id}'

    @classmethod
    def handle_put(cls, **kwargs):
        """Refresh cached counts for given CVE."""
        cve = kwargs.get("cve_id", None)
        cls._cve_exists(cve)
        DB.execute_sql("SELECT refresh_cve_cached_counts(%s)", (cve,))
        return ""


class RefreshSystem(Refresh):
    """PUT to /v1/refresh/systems/{inventory_id}"""

    _endpoint_name = r'/v1/refresh/systems/{inventory_id}'

    @classmethod
    def handle_put(cls, **kwargs):
        """Refresh cached counts for given inventory ID."""
        inventory_id = kwargs.get("inventory_id", None)
        cls._system_exists(inventory_id)
        DB.execute_sql("SELECT refresh_system_cached_counts(%s)", (inventory_id,))
        return ""


class GetMissingInInventory(GetRequest):
    """GET to /v1/systems/missing_in_inventory"""

    _endpoint_name = r'/v1/systems/missing_in_inventory'

    @classmethod
    def handle_get(cls, **kwargs):  # pylint: disable=unused-argument
        """Get count of systems in system_platform table but missing in inventory."""
        cursor = DB.execute_sql("""
            SELECT COUNT(sp.inventory_id)
            FROM system_platform sp LEFT JOIN
                 inventory.hosts ih ON CAST(sp.inventory_id AS UUID) = ih.id
            WHERE ih.id IS NULL
              AND sp.when_deleted IS NULL
        """)
        return cursor.fetchone()[0]


class DeleteMissingInInventory(DeleteRequest):
    """DELETE to /v1/systems/missing_in_inventory"""

    _endpoint_name = r'/v1/systems/missing_in_inventory'

    @classmethod
    def handle_delete(cls, **kwargs):  # pylint: disable=unused-argument
        """Delete systems from system_platform table missing in inventory."""
        DB.execute_sql("""
            UPDATE system_platform sp
               SET opt_out = true, stale = true, when_deleted = now()
            FROM (
                SELECT sp2.inventory_id
                FROM system_platform sp2 LEFT JOIN
                     inventory.hosts ih ON CAST(sp2.inventory_id AS UUID) = ih.id
                WHERE ih.id IS NULL
                  AND sp2.when_deleted IS NULL
                ORDER BY sp2.inventory_id
                FOR UPDATE OF sp2
            ) up
            WHERE sp.inventory_id = up.inventory_id
        """)
        return ""
