FROM centos:7

RUN yum -y update \
    && yum -y install centos-release-scl \
    && yum -y install rh-python36 postgresql \
    && rm -rf /var/cache/yum/*

ENV APPBASEDIR=/vmaas_sync

ADD scl-enable.sh $APPBASEDIR/
ADD requirements-vmaas-sync.txt $APPBASEDIR/

RUN adduser --gid 0 -d $APPBASEDIR --no-create-home -c 'Red Hat Insights' insights

RUN $APPBASEDIR/scl-enable.sh pip install --upgrade pip

RUN $APPBASEDIR/scl-enable.sh pip install -r $APPBASEDIR/requirements-vmaas-sync.txt

ADD $APPBASEDIR/*.sh $APPBASEDIR/
ADD $APPBASEDIR/*.py $APPBASEDIR/vmaas_sync/
ADD /common/*.py $APPBASEDIR/common/
ADD wait-for-services.sh $APPBASEDIR/

RUN touch $APPBASEDIR/__init__.py

RUN chown -R insights $APPBASEDIR

USER insights

EXPOSE 8000 8087

CMD $APPBASEDIR/scl-enable.sh $APPBASEDIR/entrypoint.sh
