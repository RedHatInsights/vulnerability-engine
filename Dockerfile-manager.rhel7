FROM registry.access.redhat.com/rhel7

RUN yum -y update \
    && yum-config-manager --enable rhel-server-rhscl-7-rpms \
    && yum -y install rh-python36 postgresql \
    && rm -rf /var/cache/yum/*

ENV APPBASEDIR=/manager
ENV INSIGHTS_VULNERABILITY_VERSION=0.14

RUN mkdir -p /tmp/prometheus_multiproc
ENV prometheus_multiproc_dir=/tmp/prometheus_multiproc

ADD scl-enable.sh $APPBASEDIR/
ADD requirements-manager.txt $APPBASEDIR/

RUN $APPBASEDIR/scl-enable.sh pip install --upgrade pip

RUN $APPBASEDIR/scl-enable.sh pip install -r $APPBASEDIR/requirements-manager.txt

ADD $APPBASEDIR/entrypoint.sh $APPBASEDIR/
ADD $APPBASEDIR/*.py $APPBASEDIR/manager/
ADD manager.spec.yaml $APPBASEDIR/
ADD /common/*.py $APPBASEDIR/common/
ADD wait-for-services.sh $APPBASEDIR/
ADD /database/*.py $APPBASEDIR/database/
ADD /database/upgrade/*.py $APPBASEDIR/database/upgrade/
ADD /database/upgrade/dbupgrade.sh $APPBASEDIR/
ADD /database/schema/upgrade_scripts/*.sql $APPBASEDIR/database/schema/upgrade_scripts/

RUN touch $APPBASEDIR/__init__.py

RUN adduser --gid 0 -d $APPBASEDIR --no-create-home -c 'Red Hat Insights' insights

RUN chown -R insights:0 /tmp/prometheus_multiproc
RUN chgrp -R 0 /tmp/prometheus_multiproc && \
    chmod -R g=u /tmp/prometheus_multiproc

USER insights

EXPOSE 8443

CMD $APPBASEDIR/scl-enable.sh $APPBASEDIR/entrypoint.sh
