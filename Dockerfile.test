FROM registry.access.redhat.com/ubi8/ubi-minimal

# install postgresql from centos if not building on RHSM system
RUN FULL_RHEL=$(microdnf repolist --enabled | grep rhel-8) ; \
    if [ -z "$FULL_RHEL" ] ; then \
    rpm -Uvh http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/Packages/centos-stream-repos-8-4.el8.noarch.rpm \
    http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/Packages/centos-gpg-keys-8-4.el8.noarch.rpm && \
    sed -i 's/^\(enabled.*\)/\1\npriority=200/;' /etc/yum.repos.d/CentOS*.repo ; \
    fi

RUN microdnf module enable postgresql:12 && \
    microdnf install --setopt=install_weak_deps=0 --setopt=tsflags=nodocs \
    python38 python38-pip python38-devel libpq-devel gcc git postgresql-server which findutils diffutils && \
    microdnf clean all

# missing pg_config, gcc, python3-devel needed for psycopg on aarch64
RUN [ "$(uname -m)" == "aarch64" ] && \
    microdnf install --setopt=install_weak_deps=0 --setopt=tsflags=nodocs \
    gcc-c++ && \
    microdnf clean all || true

# for testing.posgres python package to find postgres commands
RUN ln -s /usr/bin/initdb   /usr/local/bin/initdb && \
    ln -s /usr/bin/postgres /usr/local/bin/postgres

RUN mkdir /engine && \
    chown -R postgres:postgres /engine

WORKDIR /engine

ADD /tests/Pipfile* /engine/

ENV LC_ALL=C.utf8
ENV LANG=C.utf8
ARG PIPENV_CHECK=1
ARG PIPENV_PYUP_API_KEY=""
RUN pip3 install --upgrade pip && \
    pip3 install --upgrade pipenv && \
    pipenv install --ignore-pipfile --deploy --system && \
    if [ "${PIPENV_CHECK}" == 1 ] ; then pipenv check --system -i 45185 -i 51457 -i 55261 ; fi

ADD . /engine

RUN chown -R postgres:postgres /engine

USER postgres

# config git, required by "test_upgrade"
RUN git config --global user.email "test@test" && \
    git config --global user.name "test"
