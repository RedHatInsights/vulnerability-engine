FROM fedora:28

RUN dnf install -y python3 python3-pip git postgresql-server which findutils && \
    pip3 install --upgrade pip pipenv

# for testing.posgres python package to find postgres commands
RUN ln -s /usr/bin/initdb   /usr/local/bin/initdb && \
    ln -s /usr/bin/postgres /usr/local/bin/postgres

RUN mkdir /engine && \
    chown -R postgres:postgres /engine

USER postgres

ADD /tests/Pipfile* /engine/

WORKDIR /engine

ENV LC_ALL=en_US.utf8
ENV LANG=en_US.utf8
RUN pipenv install && pipenv check

ADD . /engine

USER root
RUN chown -R postgres:postgres /engine
USER postgres

# config git, required by "test_upgrade"
RUN git config --global user.email "test@test" && \
    git config --global user.name "test"
