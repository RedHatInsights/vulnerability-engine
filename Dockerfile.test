FROM fedora:27

RUN dnf install -y python3 python3-pip git postgresql-server findutils

# for testing.posgres python package to find postgres commands
RUN ln -s /usr/bin/initdb   /usr/local/bin/initdb && \
    ln -s /usr/bin/postgres /usr/local/bin/postgres

ADD requirements.txt             /engine/
ADD requirements-evaluator.txt   /engine/
ADD requirements-listener.txt    /engine/
ADD requirements-manager.txt     /engine/
ADD requirements-vmaas-sync.txt  /engine/

RUN pip3 install --upgrade pip && \
    pip3 install -r /engine/requirements.txt && \
    pip3 install -r /engine/requirements-evaluator.txt && \
    pip3 install -r /engine/requirements-listener.txt && \
    pip3 install -r /engine/requirements-manager.txt && \
    pip3 install -r /engine/requirements-vmaas-sync.txt

ADD . /engine

RUN chown -R postgres:postgres /engine

USER postgres

# config git, required by "test_upgrade"
RUN git config --global user.email "test@test" && \
    git config --global user.name "test"
