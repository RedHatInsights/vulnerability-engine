FROM registry.access.redhat.com/ubi8/ubi-minimal

RUN rpm -Uvh https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm && \
    microdnf install python3 python3-rpm python3-pip postgresql12-server findutils git which rsync gcc python3-devel python3-pyyaml && \
    microdnf clean all && \
    pip3 install --upgrade pipenv pip

# for testing.posgres python package to find postgres commands
RUN ln -s /usr/pgsql-12/bin/initdb /usr/local/bin/initdb && \
    ln -s /usr/pgsql-12/bin/postgres /usr/local/bin/postgres

RUN mkdir /engine && \
    chown -R postgres:postgres /engine

USER postgres

ADD /tests/Pipfile* /engine/

WORKDIR /engine

ENV LC_ALL=C.utf8
ENV LANG=C.utf8
ARG PIPENV_CHECK=1
ARG PIPENV_PYUP_API_KEY=""
RUN pipenv --site-packages install --ignore-pipfile --deploy --dev && \
    if [ "${PIPENV_CHECK}" == 1 ] ; then pipenv check ; fi

ADD . /engine

USER root
RUN chown -R postgres:postgres /engine
USER postgres

# config git, required by "test_upgrade"
RUN git config --global user.email "test@test" && \
    git config --global user.name "test"
