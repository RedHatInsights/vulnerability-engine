# Vulnerability Engine Listener Service

## Overview
Listener service is always consuming specific kafka topic where the inventory produces update messages for its systems.
Listener updates the system information (does not do evaluation of vulnerabilities yet) inside the vulnerability database based on the message and passes the event to the evaluator component.

## Design
Listener is consuming `platform.inventory.events` topic.
Message type from inventory can be:
* New system (created): New system was uploaded to the inventory.
* Reupload of system (updated): Already existing system uploaded to inventory.
* Deleted system (deleted): System got deleted from inventory.

Listener processes one of this message.
On new system, it creates a row with system info into vulnerability DB (`system_platform`, `repo`, `system_repo` table).
On update it updates already existing system fields only if the package profile changed from the last created/updated event.
On both of these operations, listener prepares a request for VMaaS with provided list of packages from the message and stores it into the db (`vmaas_json` field).
On delete, it marks system as deleted (system gets deleted later, optimization, `when_deleted` field).
After each operation (besides delete), system is passed to the evaluator for vulnerabilities analysis through another kafka topic `vulnerability.evaluator.upload` with message type `upload_new_file`.

### Incoming message
Details of the incoming kafka message can be found [here](https://consoledot.pages.redhat.com/docs/dev/services/inventory.html).
