"""Module implementing kafka listener."""

import json
import tempfile

import requests

from common import mqueue
from common.database_handler import DatabaseHandler, init_db
from common.logging import init_logging, get_logger
from .archive_parser import ArchiveParser
from .utils import VERSION, format_vmaas_request

LOGGER = get_logger(__name__)


def db_import_system(conn, inventory_id, rh_account, hostname, s3_url, vmaas_json, satellite_managed):
    """Import initial system record to the DB."""
    # TODO: json_checksum
    cur = conn.cursor()
    cur.execute("select inventory_id from system_platform where inventory_id = %s", (inventory_id,))
    system_record = cur.fetchone()
    if system_record is None:
        cur.execute("""insert into system_platform (inventory_id, rh_account, display_name, s3_url,
                                                    vmaas_json, json_checksum, satellite_managed)
                        values (%s, %s, %s, %s, %s, %s, %s)""",
                    (inventory_id, rh_account, hostname, s3_url, vmaas_json, '0', satellite_managed,))
    else:
        cur.execute("""update system_platform set rh_account = %s, display_name = %s, s3_url = %s,
                                                  vmaas_json = %s, json_checksum = %s, satellite_managed = %s
                       where inventory_id = %s""",
                    (rh_account, hostname, s3_url, vmaas_json, '0', satellite_managed, inventory_id))
    cur.close()
    conn.commit()


def main():
    """Main kafka listener entrypoint."""
    init_logging()
    init_db()
    LOGGER.info("Starting upload listener (version %s).", VERSION)
    # get DB connection
    conn = DatabaseHandler.get_connection()
    upload_queue = mqueue.MQReader(mqueue.UPLOAD_TOPIC)
    vuln_queue = mqueue.MQWriter(mqueue.EVALUATOR_TOPIC)

    def process_upload(msg):
        """Message processing logic"""
        LOGGER.info('Received message from topic %s: %s', msg.topic, msg.value)

        upload_data = json.loads(msg.value.decode("utf8"))

        # Inventory ID is missing
        if 'id' not in upload_data or upload_data["id"] is None:
            LOGGER.warning("Unable to store system, inventory ID is missing.")
            return

        # Download archive an parse
        with tempfile.NamedTemporaryFile(delete=True) as tmp_file:
            LOGGER.debug("Writing temp file to %s", tmp_file.name)
            response = requests.get(upload_data["url"], stream=True, allow_redirects=True)
            for chunk in response.iter_content(chunk_size=1024):
                if chunk:  # filter out keep-alive new chunks
                    tmp_file.write(chunk)
            tmp_file.flush()
            parser = ArchiveParser(tmp_file.name)
            if not parser.parse():
                return

        db_import_system(conn, upload_data["id"], upload_data["rh_account"], parser.hostname,
                         upload_data["url"], format_vmaas_request(parser.package_list, parser.repo_list),
                         parser.satellite_managed)
        new_upload_msg = {"type": "upload_new_file", "system_id": upload_data["id"]}
        vuln_queue.send(new_upload_msg)
        LOGGER.info('Sent message to topic %s: %s', mqueue.EVALUATOR_TOPIC, json.dumps(new_upload_msg).encode("utf8"))

    upload_queue.listen(process_upload)

if __name__ == '__main__':
    main()
