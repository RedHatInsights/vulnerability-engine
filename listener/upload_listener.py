#!/usr/bin/python3

import os
import logging
import datetime
import json
import mqueue

from common.logging import init_logging, get_logger
from utils import uuid, VERSION

LOGGER = get_logger(__name__)


def main():
    init_logging()
    LOGGER.info("Starting upload listener (version %s).", VERSION)
    upload_queue = mqueue.QReader('uploadvalidation', 'vulnerability')
    vuln_queue = mqueue.QWriter()

    for msg in upload_queue:
        LOGGER.info('Received Platform Kafka message at %s from topic %s: %s',
                     datetime.datetime.now(), msg.topic, msg.value)
        upload_data = json.loads(msg.value.decode("utf8"))
        new_upload_msg = {"type": "upload_new_file",
                          "version": 1,
                          "correlation_id": uuid(),
                          "principal": upload_data["principal"],
                          "rh_account": upload_data["rh_account"],
                          "url": upload_data["url"],
                         }
        vuln_queue.send(new_upload_msg)
        LOGGER.info('Sent vulnerability message: %s', json.dumps(new_upload_msg).encode("utf8"))

if __name__ == '__main__':
    main()
