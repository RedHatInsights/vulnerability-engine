"""Module with classes for working with uploaded archives."""

from prometheus_client import Counter

from insights.core import archives, dr
from insights.core.context import HostArchiveContext
from insights.core.hydration import create_context
from insights.parsers.dnf_modules import DnfModules
from insights.parsers.installed_rpms import Installed
from insights.parsers.ls_etc import LsEtc
from insights.parsers.subscription_manager_list import SubscriptionManagerReposListEnabled

from common.logging import get_logger

ARCHIVE_PARSE_COUNT = Counter('ve_listener_arch_parse_calls', '# of archive parse-attempts')
RPMDB_PARSE_FAILURE = Counter('ve_listener_arch_rpmdb_parse_failures',
                              '# of failures to parse package-list from archive')
REPOLIST_PARSE_FAILURE = Counter('ve_listener_arch_repolist_parse_failures',
                                 '# of failures to parse repolist from archive')
ETC_PARSE_FAILURE = Counter('ve_listener_arch_etc_parse_failures', '# of failures to parse /etc files from archive')

LOGGER = get_logger(__name__)

SATELLITE_MANAGED_FILES = {
    "sat5": ["/etc/sysconfig/rhn", "systemid"],
    "sat6": ["/etc/rhsm/ca", "katello-server-ca.pem"]
}


class ArchiveParser:
    """Class working with uploaded archive."""
    def __init__(self, archive_path):
        self.archive_path = archive_path
        self.package_list = []
        self.repo_list = []
        self.satellite_managed = False
        self.modules_list = []

    def parse(self):
        # pylint: disable=too-many-branches
        """Parse given archive."""
        ARCHIVE_PARSE_COUNT.inc()
        default_packages = (
            "insights.specs.default",
            "insights.specs.insights_archive",
            "insights.combiners",
            "insights.parsers"
        )
        for pkg in default_packages:
            dr.load_components(pkg)
        broker = dr.Broker()

        with archives.extract(self.archive_path) as ex:
            ctx = create_context(ex.tmp_dir, HostArchiveContext)
            broker[ctx.__class__] = ctx
            broker = dr.run(components=[LsEtc, Installed, SubscriptionManagerReposListEnabled, DnfModules],
                            broker=broker)

            if Installed in broker:
                pkglist = broker[Installed]
                for pkg_name in pkglist.packages:
                    pkg = pkglist.get_max(pkg_name)
                    self.package_list.append("%s-%s:%s-%s.%s" % (
                        pkg.name, pkg.epoch, pkg.version, pkg.release, pkg.arch))
            else:
                RPMDB_PARSE_FAILURE.inc()
                LOGGER.error("Unable to parse package list from archive.")
                return

            if SubscriptionManagerReposListEnabled in broker:
                repolist = broker[SubscriptionManagerReposListEnabled]
                for repo_record in repolist.records:
                    repo_label = repo_record.get("Repo ID", None)
                    if repo_label:
                        self.repo_list.append(repo_label)

            if not self.repo_list:
                REPOLIST_PARSE_FAILURE.inc()
                LOGGER.warning("Unable to parse RHSM repo list from archive.")

            if LsEtc in broker:
                self.satellite_managed = any([broker[LsEtc].dir_contains(*satellite_file)
                                              for satellite_file in SATELLITE_MANAGED_FILES.values()
                                              if satellite_file[0] in broker[LsEtc]])
            else:
                ETC_PARSE_FAILURE.inc()
                LOGGER.warning("Unable to parse /etc content from archive, satellite_managed status is not known.")

            if DnfModules in broker:
                for module in broker[DnfModules]:
                    for module_name in module.sections():
                        self.modules_list.append({'module_name': module_name,
                                                  'module_stream': module.get(module_name, 'stream')})
